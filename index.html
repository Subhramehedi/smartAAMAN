<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Al Ameen Mission Academy Nayabaz Attendance Tracker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      .logo {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        margin: 0 auto 10px;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      }
      .room-buttons-wrapper {
        overflow-x: auto;
        padding-bottom: 5px;
        scrollbar-width: none;
        -ms-overflow-style: none;
      }
      .room-buttons-wrapper::-webkit-scrollbar {
        display: none;
      }
      @media (max-width: 480px) {
        .room-btn {
          font-size: 11px;
          padding: 8px 10px;
          white-space: nowrap;
        }
      }
      .room-buttons {
        display: flex;
        gap: 10px;
        flex-wrap: nowrap;
        min-width: max-content;
      }
      .blast-effect {
        position: relative;
        overflow: hidden;
        z-index: 1;
      }
      .blast-effect::before {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        background: radial-gradient(
          circle,
          rgba(255, 255, 255, 0.8) 0%,
          rgba(255, 255, 255, 0) 70%
        );
        border-radius: 50%;
        opacity: 0;
        transform: translate(-50%, -50%);
        transition: none;
        pointer-events: none;
        z-index: 2;
      }
      .blast-effect.active::before {
        animation: blast 0.4s ease-out forwards;
      }
      @keyframes blast {
        0% {
          width: 0;
          height: 0;
          opacity: 0.8;
        }
        100% {
          width: 200%;
          height: 200%;
          opacity: 0;
        }
      }
      .nav-btn {
        padding: 10px 20px;
        border: none;
        border-radius: 20px;
        background: linear-gradient(135deg, #0f4c75 0%, #3282b8 100%);
        color: white;
        font-size: 14px;
        font-weight: bold;
        box-shadow: 0 4px 8px rgba(15, 76, 117, 0.3);
        transition: all 0.3s ease;
      }
      .nav-btn:hover:not(:disabled) {
        transform: translateY(-3px);
        background: linear-gradient(135deg, #3282b8 0%, #0f4c75 100%);
        box-shadow: 0 6px 12px rgba(15, 76, 117, 0.4);
      }
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: "Poppins", sans-serif;
        background: linear-gradient(
          135deg,
          #0f4c75 0%,
          #3282b8 50%,
          #bbe1fa 100%
        );
        min-height: 100vh;
        padding: 10px;
      }
      .container {
        max-width: 400px;
        margin: 0 auto;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }
      .header {
        background: linear-gradient(135deg, #0f4c75 0%, #3282b8 100%);
        padding: 20px;
        text-align: center;
        color: white;
        position: relative;
        overflow: hidden;
      }
      .header::before {
        content: "";
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="islamic-pattern" x="0" y="0" width="20" height="20" patternUnits="userSpaceOnUse"><circle cx="10" cy="10" r="2" fill="rgba(255,255,255,0.1)"/><path d="M10 5 L15 10 L10 15 L5 10 Z" fill="rgba(255,255,255,0.05)"/></pattern></defs><rect width="100" height="100" fill="url(%23islamic-pattern)"/></svg>')
          repeat;
        z-index: 1;
      }
      .header-content {
        position: relative;
        z-index: 2;
      }
      .logo {
        width: 60px;
        height: 60px;
        background: linear-gradient(135deg, #ffd700 0%, #ffa500 100%);
        border-radius: 50%;
        margin: 0 auto 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
        border: 3px solid rgba(255, 255, 255, 0.3);
      }
      .logo-animation-container {
        overflow: hidden;
        height: 80px;
        margin-bottom: 10px;
        margin: 0 auto 10px;
        display: flex;
        align-items: flex-end;
        justify-content: center;
      }
      .logo-animation-container .logo {
        animation: logoSlideUpFadeIn 1s ease-out forwards;
        transform: translateY(100%);
        opacity: 0;
      }
      @keyframes logoSlideUpFadeIn {
        0% {
          transform: translateY(100%);
          opacity: 0;
        }
        60% {
          opacity: 1;
        }
        100% {
          transform: translateY(0);
          opacity: 1;
        }
      }
      .header h1 {
        font-size: 1.3rem;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        font-weight: 600;
      }
      .date-selector {
        background: rgba(255, 255, 255, 0.2);
        padding: 15px;
        border-radius: 10px;
        margin-top: 10px;
      }
      .date-inputs {
        display: flex;
        gap: 10px;
        justify-content: center;
      }
      .date-inputs select {
        padding: 8px;
        border: none;
        border-radius: 5px;
        background: white;
        font-size: 14px;
      }
      .room-nav {
        padding: 20px;
        background: #f8f9fa;
        border-bottom: 1px solid #e9ecef;
      }
      .room-buttons {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: center;
        margin-bottom: 15px;
      }
      .room-btn {
        padding: 10px 15px;
        border: none;
        border-radius: 20px;
        background: #e9ecef;
        color: #495057;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 12px;
      }
      .room-btn.active {
        background: linear-gradient(135deg, #0f4c75 0%, #3282b8 100%);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(15, 76, 117, 0.4);
      }
      .navigation {
        display: flex;
        justify-content: space-between;
        margin-top: 15px;
      }
      .nav-btn {
        padding: 8px 16px;
        border: none;
        border-radius: 15px;
        background: #6c757d;
        color: white;
        cursor: pointer;
        font-size: 12px;
      }
      .nav-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .search-section {
        padding: 20px;
        background: #f8f9fa;
        border-bottom: 1px solid #e9ecef;
      }
      .search-input {
        width: 100%;
        padding: 12px;
        border: 2px solid #e9ecef;
        border-radius: 10px;
        font-size: 14px;
        transition: border-color 0.3s ease;
      }
      .search-input:focus {
        outline: none;
        border-color: #3282b8;
        box-shadow: 0 0 10px rgba(50, 130, 184, 0.2);
      }
      .search-results {
        margin-top: 10px;
        max-height: 200px;
        overflow-y: auto;
      }
      .search-result-item {
        padding: 10px;
        background: white;
        border-radius: 8px;
        margin-bottom: 5px;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 1px solid #e9ecef;
      }
      .search-result-item:hover {
        background: #f8f9fa;
        transform: translateY(-1px);
      }
      .search-result-name {
        font-weight: 600;
        color: #495057;
        font-size: 14px;
      }
      .search-result-details {
        color: #6c757d;
        font-size: 12px;
      }
      .content {
        padding: 20px;
        max-height: 60vh;
        overflow-y: auto;
      }
      .room-title {
        text-align: center;
        margin-bottom: 20px;
        color: #495057;
        font-size: 1.2rem;
        font-weight: 600;
      }
      .student-card {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 15px;
        margin-bottom: 10px;
        border: 2px solid transparent;
        transition: all 0.3s ease;
      }
      .student-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
      }
      .student-card.present {
        border-color: #0f4c75;
        background: linear-gradient(135deg, #e8f4fd 0%, #d1e7f0 100%);
        border-left: 4px solid #0f4c75;
      }
      .student-card.absent {
        border-color: #dc3545;
        background: linear-gradient(135deg, #fff5f5 0%, #fed7d7 100%);
        border-left: 4px solid #dc3545;
      }
      .student-card.highlighted {
        border-color: #ffd700;
        background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
        border-left: 4px solid #ffd700;
        animation: highlight 1s ease-in-out;
      }
      @keyframes highlight {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
        100% {
          transform: scale(1);
        }
      }
      .student-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .student-name {
        font-weight: 600;
        color: #495057;
        font-size: 14px;
      }
      .student-reg {
        color: #6c757d;
        font-size: 12px;
      }
      .attendance-status {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .status-indicator {
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 12px;
        font-weight: 600;
      }
      .status-present {
        background: linear-gradient(135deg, #0f4c75 0%, #3282b8 100%);
        color: white;
        border-radius: 15px;
        padding: 5px 12px;
        font-size: 11px;
        font-weight: 600;
        box-shadow: 0 2px 4px rgba(15, 76, 117, 0.3);
      }
      .status-absent {
        background: #dc3545;
        color: white;
      }
      .toggle-btn {
        padding: 5px 10px;
        border: none;
        border-radius: 15px;
        cursor: pointer;
        font-size: 12px;
        font-weight: 600;
        transition: all 0.3s ease;
      }
      .toggle-present {
        background: linear-gradient(135deg, #0f4c75 0%, #3282b8 100%);
        color: white;
        border-radius: 15px;
        padding: 5px 12px;
        font-size: 11px;
        box-shadow: 0 2px 4px rgba(15, 76, 117, 0.3);
      }
      .toggle-absent {
        background: #dc3545;
        color: white;
      }
      .actions {
        padding: 20px;
        background: #f8f9fa;
        border-top: 1px solid #e9ecef;
      }
      .action-btn {
        width: 100%;
        padding: 12px;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 10px;
        transition: all 0.3s ease;
      }
      .mark-all-btn {
        background: linear-gradient(135deg, #0f4c75 0%, #3282b8 100%);
        color: white;
        margin-bottom: 10px;
        box-shadow: 0 4px 8px rgba(15, 76, 117, 0.3);
      }
      .mark-all-btn:hover {
        background: linear-gradient(135deg, #3282b8 0%, #0f4c75 100%);
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(15, 76, 117, 0.4);
      }
      .export-btn {
        background: linear-gradient(135deg, #ffd700 0%, #ffa500 100%);
        color: #0f4c75;
        font-weight: bold;
        box-shadow: 0 4px 8px rgba(255, 215, 0, 0.3);
      }
      .export-btn:hover:not(:disabled) {
        background: linear-gradient(135deg, #ffa500 0%, #ffd700 100%);
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(255, 215, 0, 0.4);
      }
      .export-btn:disabled {
        background: #6c757d;
        cursor: not-allowed;
      }
      .progress {
        margin-top: 15px;
        background: #e9ecef;
        border-radius: 10px;
        height: 8px;
        overflow: hidden;
      }
      .progress-bar {
        height: 100%;
        background: linear-gradient(135deg, #0f4c75 0%, #3282b8 100%);
        transition: width 0.3s ease;
        border-radius: 10px;
      }
      .progress-text {
        text-align: center;
        margin-top: 5px;
        font-size: 12px;
        color: #6c757d;
      }
      .stats {
        display: flex;
        justify-content: space-around;
        margin-bottom: 15px;
        padding: 10px;
        background: white;
        border-radius: 10px;
      }
      .stat-item {
        text-align: center;
      }
      .stat-number {
        font-size: 18px;
        font-weight: bold;
        color: #495057;
      }
      .stat-label {
        font-size: 12px;
        color: #6c757d;
      }
      .stat-present {
        color: #0f4c75;
        font-weight: bold;
      }
      .stat-absent {
        color: #dc3545;
      }
      .login-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        padding: 20px;
        background: linear-gradient(
          135deg,
          #0f4c75 0%,
          #3282b8 50%,
          #bbe1fa 100%
        );
      }
      .login-box {
        background: white;
        padding: 40px;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        text-align: center;
        width: 100%;
        max-width: 350px;
        min-height: 550px;
        position: relative;
        position: absolute;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
      }
      .login-box h2 {
        color: #0f4c75;
        margin-bottom: 20px;
        font-size: 1.5rem;
      }
      .login-box input,
      .login-box select {
        width: calc(100% - 20px);
        padding: 12px;
        margin-bottom: 15px;
        border: 1px solid #e9ecef;
        border-radius: 10px;
        font-size: 16px;
      }
      .login-box input:focus,
      .login-box select:focus {
        outline: none;
        border-color: #3282b8;
        box-shadow: 0 0 0 3px rgba(50, 130, 184, 0.2);
      }
      .login-box button {
        width: 100%;
        padding: 12px;
        border: none;
        border-radius: 10px;
        background: linear-gradient(135deg, #0f4c75 0%, #3282b8 100%);
        color: white;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
      }
      .login-box button:hover {
        background: linear-gradient(135deg, #3282b8 0%, #0f4c75 100%);
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(15, 76, 117, 0.4);
      }
      .hidden {
        display: none !important;
      }
      @media (max-width: 480px) {
        .container {
          margin: 0;
          border-radius: 0;
          min-height: 100vh;
        }
        .date-inputs {
          flex-direction: column;
          gap: 5px;
        }
        .date-inputs select {
          width: 100%;
        }
        .student-info {
          flex-direction: column;
          align-items: flex-start;
          gap: 10px;
        }
        .attendance-status {
          width: 100%;
          justify-content: space-between;
        }
      }
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
      }
      .loading-overlay.show {
        opacity: 1;
        visibility: visible;
      }
      .loading-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: rgba(255, 255, 255, 0.1);
        padding: 30px;
        border-radius: 20px;
        box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
      }
      .loading-logo-wrapper {
        position: relative;
        width: 100px;
        height: 100px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 20px;
        box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7);
        animation: pulse 2s infinite;
      }
      .loading-logo {
        width: 90%;
        height: 90%;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid rgba(255, 255, 255, 0.5);
      }
      @keyframes pulse {
        0% {
          box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7);
        }
        70% {
          box-shadow: 0 0 0 20px rgba(255, 215, 0, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(255, 215, 0, 0);
        }
      }
      .loading-text {
        color: white;
        font-size: 1.5rem;
        font-weight: bold;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
      }
      .loading-ring {
        border: 8px solid rgba(255, 255, 255, 0.3);
        border-top: 8px solid #ffd700;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin-top: 20px;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .camera-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
      }
      .camera-modal.show {
        opacity: 1;
        visibility: visible;
      }
      .camera-container {
        width: 90%;
        max-width: 400px;
        background: white;
        border-radius: 20px;
        padding: 20px;
        text-align: center;
      }
      .camera-video {
        width: 100%;
        max-width: 320px;
        height: 240px;
        border-radius: 10px;
        background: #000;
        margin-bottom: 20px;
        transform: scaleX(-1);
      }
      .camera-canvas {
        display: none;
      }
      .camera-controls {
        display: flex;
        gap: 10px;
        justify-content: center;
        flex-wrap: wrap;
      }
      .camera-btn {
        padding: 12px 20px;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.3s ease;
      }
      .camera-capture {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
      }
      .camera-retake {
        background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
        color: white;
      }
      .camera-cancel {
        background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%);
        color: white;
      }
      .camera-send {
        background: linear-gradient(135deg, #007bff 0%, #6610f2 100%);
        color: white;
      }
      .camera-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }
      .captured-image {
        width: 100%;
        max-width: 320px;
        height: 240px;
        border-radius: 10px;
        object-fit: cover;
        margin-bottom: 20px;
      }
      .report-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
      }
      .report-modal.show {
        opacity: 1;
        visibility: visible;
      }
      .report-content {
        width: 95%;
        height: 95%;
        max-width: 1200px;
        background: white;
        border-radius: 20px;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      .report-header {
        background: linear-gradient(135deg, #0f4c75 0%, #3282b8 100%);
        color: white;
        padding: 20px;
        text-align: center;
        position: relative;
      }
      .report-close-btn {
        position: absolute;
        right: 20px;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 20px;
        transition: all 0.3s ease;
      }
      .report-close-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: translateY(-50%) scale(1.1);
      }
      .report-iframe {
        flex: 1;
        border: none;
        width: 100%;
        height: 100%;
      }
      @media (max-width: 768px) {
        .report-content {
          width: 100%;
          height: 100%;
          border-radius: 0;
        }
      }
    </style>
  </head>
  <body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
      <div class="login-box">
        <div class="logo-animation-container">
          <div class="logo">
            <img
              src="https://play-lh.googleusercontent.com/gufR1twVlU6_SzC-iIAD_8bLLf-XYVAwwwwJF-cphD32IX0GeHNLi4GrN42hRYDHg-A"
              alt="Logo"
              style="width: 100%; height: 100%; border-radius: 50%"
            />
          </div>
        </div>
        <h2>Staff Login</h2>
        <input
          type="text"
          id="staffIdInput"
          placeholder="Staff ID লিখুন"
          oninput="fillStaffName()"
        />
        <input
          type="text"
          id="staffNameInput"
          placeholder="স্টাফের নাম"
          disabled
        />
        <input
          type="password"
          id="staffPasswordInput"
          placeholder="পাসওয়ার্ড লিখুন"
        />
        <select id="floorSelect">
          <option value="">ফ্লোর নির্বাচন করুন</option>
          <option value="old">Old Building (Room 14,15 etc.)</option>
          <option value="1">ফ্লোর 1 (Room 101-105)</option>
          <option value="2">ফ্লোর 2 (Room 201-205)</option>
          <option value="3">ফ্লোর 3 (Room 301-305)</option>
          <option value="4">ফ্লোর 4 (Room 401-404)</option>
          <option value="5">ফ্লোর 5 (Room 501-505)</option>
          <option value="6">ফ্লোর 6 (Room 601-605)</option>
        </select>
        <button class="blast-effect" onclick="startAttendance()">
          শুরু করুন
        </button>
        <button
          class="blast-effect"
          onclick="openAttendanceReport()"
          style="
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            margin-top: 10px;
          "
        >
          📊 Attendance Report
        </button>
      </div>
    </div>

    <!-- Main Attendance System -->
    <div id="attendanceSystem" class="container hidden">
      <div class="header">
        <div class="header-content">
          <div class="logo">
            <img
              src="https://play-lh.googleusercontent.com/gufR1twVlU6_SzC-iIAD_8bLLf-XYVAwwwwJF-cphD32IX0GeHNLi4GrN42hRYDHg-A"
              alt="Logo"
              style="width: 100%; height: 100%; border-radius: 50%"
            />
          </div>
          <h1>Al Ameen Mission Academy Nayabaz</h1>
          <p style="font-size: 14px; opacity: 0.9; margin-top: 5px">
            📋 Attendance Tracker
          </p>
        </div>
        <div class="date-selector">
          <div class="date-inputs">
            <select id="daySelect" disabled></select>
            <select id="monthSelect" disabled></select>
            <select id="yearSelect" disabled></select>
          </div>
        </div>
      </div>

      <div class="search-section">
        <input
          type="text"
          id="searchInput"
          class="search-input"
          placeholder="🔍 নাম বা রেজিস্ট্রেশন নম্বর দিয়ে খুঁজুন..."
          oninput="searchStudents()"
        />
        <div id="searchResults" class="search-results"></div>
      </div>

      <div class="room-nav">
        <div class="room-buttons-wrapper">
          <div class="room-buttons" id="roomButtons"></div>
        </div>
        <div class="navigation">
          <button
            class="nav-btn blast-effect"
            id="prevBtn"
            onclick="navigateRoom(-1)"
          >
            ← Previous
          </button>
          <button
            class="nav-btn blast-effect"
            id="nextBtn"
            onclick="navigateRoom(1)"
          >
            Next →
          </button>
        </div>
      </div>

      <div class="content">
        <div class="room-title" id="roomTitle"></div>
        <div class="stats">
          <div class="stat-item">
            <div class="stat-number stat-present" id="presentCount">0</div>
            <div class="stat-label">হাজির</div>
          </div>
          <div class="stat-item">
            <div class="stat-number stat-absent" id="absentCount">0</div>
            <div class="stat-label">অনুপস্থিত</div>
          </div>
          <div class="stat-item">
            <div class="stat-number" id="totalCount">0</div>
            <div class="stat-label">মোট</div>
          </div>
        </div>
        <div id="studentList"></div>
      </div>

      <div class="actions">
        <button
          class="action-btn mark-all-btn blast-effect"
          onclick="markAllPresent()"
        >
          ✅ সবাইকে হাজির করুন
        </button>
        <button
          class="action-btn export-btn blast-effect"
          id="submitBtn"
          onclick="submitAttendance()"
        >
          📸 ছবি তুলে অ্যাটেনডেন্স জমা দিন
        </button>
        <div class="progress">
          <div class="progress-bar" id="progressBar"></div>
        </div>
        <div class="progress-text" id="progressText"></div>
      </div>
    </div>

    <!-- Camera Modal -->
    <div id="cameraModal" class="camera-modal">
      <div class="camera-container">
        <h3 style="color: #0f4c75; margin-bottom: 20px">📸 ছবি তুলুন</h3>
        <video
          id="cameraVideo"
          class="camera-video"
          autoplay
          playsinline
        ></video>
        <canvas id="cameraCanvas" class="camera-canvas"></canvas>
        <img id="capturedImage" class="captured-image" style="display: none" />
        <div class="camera-controls">
          <button
            id="captureBtn"
            class="camera-btn camera-capture"
            onclick="capturePhoto()"
          >
            📸 ছবি তুলুন
          </button>
          <button
            id="retakeBtn"
            class="camera-btn camera-retake"
            onclick="retakePhoto()"
            style="display: none"
          >
            🔄 আবার তুলুন
          </button>
          <button
            id="sendBtn"
            class="camera-btn camera-send"
            onclick="sendPhotoAndSubmit()"
            style="display: none"
          >
            📤 পাঠান
          </button>
          <button class="camera-btn camera-cancel" onclick="closeCameraModal()">
            ❌ বাতিল
          </button>
        </div>
      </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay hidden">
      <div class="loading-content">
        <div class="loading-logo-wrapper">
          <img
            src="https://play-lh.googleusercontent.com/gufR1twVlU6_SzC-iIAD_8bLLf-XYVAwwwwJF-cphD32IX0GeHNLi4GrN42hRYDHg-A"
            alt="Logo"
            class="loading-logo"
          />
        </div>
        <p class="loading-text">Loading...</p>
        <div class="loading-ring"></div>
      </div>
    </div>

    <!-- Attendance Report Modal -->
    <div id="reportModal" class="report-modal">
      <div class="report-content">
        <div class="report-header">
          <button class="report-close-btn" onclick="closeAttendanceReport()">
            ×
          </button>
        </div>
        <iframe
          id="reportIframe"
          class="report-iframe"
          src=""
          title="Attendance Report"
        ></iframe>
      </div>
    </div>

    <script>
      let floorWiseAttendance = {};
      let classWiseData = {};
      let dailyClassReport = {};
      let staffLocation = { lat: null, lon: null, distance: null };

      function getOperatingSystem() {
        const userAgent = navigator.userAgent;
        if (userAgent.indexOf("Win") !== -1) return "Windows";
        if (userAgent.indexOf("Mac") !== -1) return "MacOS";
        if (userAgent.indexOf("Linux") !== -1) return "Linux";
        if (userAgent.indexOf("Android") !== -1) return "Android";
        if (
          userAgent.indexOf("iPhone") !== -1 ||
          userAgent.indexOf("iPad") !== -1
        )
          return "iOS";
        return "Unknown OS";
      }

      function getBrowserName() {
        const userAgent = navigator.userAgent;
        if (
          userAgent.indexOf("Chrome") !== -1 &&
          userAgent.indexOf("Edge") === -1
        )
          return "Chrome";
        if (userAgent.indexOf("Firefox") !== -1) return "Firefox";
        if (
          userAgent.indexOf("Safari") !== -1 &&
          userAgent.indexOf("Chrome") === -1
        )
          return "Safari";
        if (userAgent.indexOf("Edge") !== -1) return "Edge";
        if (
          userAgent.indexOf("Opera") !== -1 ||
          userAgent.indexOf("OPR") !== -1
        )
          return "Opera";
        return "Unknown Browser";
      }

      function getDeviceName() {
        const platform = navigator.platform || "Unknown Platform";
        const userAgent = navigator.userAgent;
        if (userAgent.indexOf("Android") !== -1) {
          const match = userAgent.match(/Android [0-9\.]+; (.+?)\)/);
          return match ? match[1] : "Android Device";
        }
        if (userAgent.indexOf("iPhone") !== -1) return "iPhone";
        if (userAgent.indexOf("iPad") !== -1) return "iPad";
        return platform;
      }

      function getUserLocation() {
        const targetLat = 22.59158;
        const targetLon = 88.27662;
        return new Promise((resolve) => {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              const userLat = position.coords.latitude;
              const userLon = position.coords.longitude;
              const distance = calculateDistance(
                userLat,
                userLon,
                targetLat,
                targetLon
              );
              resolve({
                lat: userLat.toFixed(5),
                lon: userLon.toFixed(5),
                distance: distance,
              });
            },
            (error) => {
              resolve({
                lat: "Unknown",
                lon: "Unknown",
                distance: "Unknown",
              });
            }
          );
        });
      }

      function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371000;
        const toRad = (value) => (value * Math.PI) / 180;
        const dLat = toRad(lat2 - lat1);
        const dLon = toRad(lon2 - lon1);
        const a =
          Math.sin(dLat / 2) * Math.sin(dLat / 2) +
          Math.cos(toRad(lat1)) *
            Math.cos(toRad(lat2)) *
            Math.sin(dLon / 2) *
            Math.sin(dLon / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return Math.round(R * c);
      }

      const TELEGRAM_BOT_TOKEN =
        "7943273526:AAF3obKo6jlMXLZmdHbJvrNrDoaogVGJRq0";
      const TELEGRAM_CHAT_ID = "-4814783764";
      const staffCredentials = {
        staff01: { name: "Subhra Mehedi", password: "8597111396" },
        staff02: { name: "Saddam Khan", password: "7548976846" },
        staff03: { name: "Safiqul Alam", password: "9732429502" },
        staff04: { name: "Sk Atikur Rahaman", password: "9775256530" },
        staff05: { name: "Mustak Ahmed", password: "9641414243" },
        staff06: { name: "Sk Abu Mostak", password: "7001580299" },
        staff07: { name: "Sk Arif Ikbal", password: "7866043778" },
        staff08: { name: "Rukubuddin Khan", password: "9002200218" },
        staff09: { name: "Sk Hakimul Rahaman", password: "9382645296" },
        staff10: { name: "Md Arif", password: "9734716482" },
        staff11: { name: "Helal Uddin", password: "6289485440" },
        staff12: { name: "Shukur Ali Middya", password: "9330893655" },
        staff13: { name: "Rajibul Hossain Khan", password: "8670392187" },
        staff14: { name: "Suraj Khan", password: "9062974318" },
        staff15: { name: "Sk Irfan", password: "7679768416" },
      };

      function generateDeviceFingerprint() {
        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        ctx.textBaseline = "top";
        ctx.font = "14px Arial";
        ctx.fillText("Device fingerprint", 2, 2);
        const fingerprint = [
          navigator.userAgent,
          navigator.language,
          screen.width + "x" + screen.height,
          screen.colorDepth,
          new Date().getTimezoneOffset(),
          !!window.localStorage,
          !!window.sessionStorage,
          canvas.toDataURL(),
        ].join("|");
        let hash = 0;
        for (let i = 0; i < fingerprint.length; i++) {
          const char = fingerprint.charCodeAt(i);
          hash = (hash << 5) - hash + char;
          hash = hash & hash;
        }
        return Math.abs(hash).toString(16);
      }

      async function verifyDeviceAccess(staffId, staffName, locationData) {
        const deviceFingerprint = generateDeviceFingerprint();
        const deviceName = getDeviceName();
        const osName = getOperatingSystem();
        const browserName = getBrowserName();
        try {
          const verifyParams = new URLSearchParams({
            action: "verifyDevice",
            staffId: staffId,
            staffName: staffName,
            deviceFingerprint: deviceFingerprint,
            deviceName: deviceName,
            osName: osName,
            browserName: browserName,
            lat: locationData.lat,
            lon: locationData.lon,
            distance: locationData.distance,
          });
          const response = await fetch(
            `${WEB_APP_URL}?${verifyParams.toString()}`
          );
          if (!response.ok)
            throw new Error(`HTTP error! status: ${response.status}`);
          const result = await response.json();
          return result;
        } catch (error) {
          console.error("Device verification error:", error);
          return { status: "error", message: "Device verification failed" };
        }
      }

      function fillStaffName() {
        const id = document.getElementById("staffIdInput").value.trim();
        const nameInput = document.getElementById("staffNameInput");
        if (staffCredentials[id]) {
          nameInput.value = staffCredentials[id].name;
        } else {
          nameInput.value = "";
        }
      }

      const WEB_APP_URL =
        "https://script.google.com/macros/s/AKfycbwJngWN-IqxsTPleZ-wsbVpmhwT_kOTrlz_wqEhPgEsBpYzvoDGtcOHxeznuP7nkCx4PQ/exec";
      let studentsData = {};
      let currentRoomIndex = 0;
      let attendance = {};
      let allRooms = [];
      let floorRooms = [];
      let highlightedStudent = null;
      let staffName = "";
      let selectedFloor = "";
      let serverDate = "";
      let cameraStream = null;
      let capturedPhotoBlob = null;

      async function openCameraModal() {
        const modal = document.getElementById("cameraModal");
        const video = document.getElementById("cameraVideo");
        try {
          cameraStream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: "user" },
          });
          video.srcObject = cameraStream;
          modal.classList.add("show");
          document.getElementById("captureBtn").style.display = "inline-block";
          document.getElementById("retakeBtn").style.display = "none";
          document.getElementById("sendBtn").style.display = "none";
          document.getElementById("capturedImage").style.display = "none";
          video.style.display = "block";
        } catch (error) {
          console.error("Error accessing camera:", error);
          alert(
            "ক্যামেরা অ্যাক্সেস করতে সমস্যা হয়েছে। অনুগ্রহ করে ব্রাউজারে ক্যামেরার অনুমতি দিন।"
          );
        }
      }

      function closeCameraModal() {
        const modal = document.getElementById("cameraModal");
        const submitBtn = document.getElementById("submitBtn");
        modal.classList.remove("show");
        if (cameraStream) {
          cameraStream.getTracks().forEach((track) => track.stop());
          cameraStream = null;
        }
        capturedPhotoBlob = null;
        submitBtn.disabled = false;
        submitBtn.textContent = "📸 ছবি তুলে অ্যাটেনডেন্স জমা দিন";
      }

      function capturePhoto() {
        const video = document.getElementById("cameraVideo");
        const canvas = document.getElementById("cameraCanvas");
        const capturedImage = document.getElementById("capturedImage");
        const ctx = canvas.getContext("2d");
        const videoWidth = video.videoWidth;
        const videoHeight = video.videoHeight;
        canvas.width = videoWidth;
        canvas.height = videoHeight;
        ctx.save();
        ctx.translate(videoWidth, 0);
        ctx.scale(-1, 1);
        ctx.drawImage(video, 0, 0, videoWidth, videoHeight);
        ctx.restore();
        canvas.toBlob(
          (blob) => {
            capturedPhotoBlob = blob;
            const imageUrl = URL.createObjectURL(blob);
            capturedImage.src = imageUrl;
            capturedImage.style.display = "block";
            video.style.display = "none";
            document.getElementById("captureBtn").style.display = "none";
            document.getElementById("retakeBtn").style.display = "inline-block";
            document.getElementById("sendBtn").style.display = "inline-block";
          },
          "image/jpeg",
          0.8
        );
      }

      function retakePhoto() {
        const video = document.getElementById("cameraVideo");
        const capturedImage = document.getElementById("capturedImage");
        capturedImage.style.display = "none";
        video.style.display = "block";
        document.getElementById("captureBtn").style.display = "inline-block";
        document.getElementById("retakeBtn").style.display = "none";
        document.getElementById("sendBtn").style.display = "none";
        capturedPhotoBlob = null;
      }

      async function sendPhotoToTelegram(photoBlob, caption) {
        const formData = new FormData();
        formData.append("chat_id", TELEGRAM_CHAT_ID);
        formData.append("photo", photoBlob, "attendance.jpg");
        formData.append("caption", caption);
        try {
          const response = await fetch(
            `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendPhoto`,
            {
              method: "POST",
              body: formData,
            }
          );
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const result = await response.json();
          return result.ok;
        } catch (error) {
          console.error("Error sending photo to Telegram:", error);
          return false;
        }
      }

      async function sendPhotoAndSubmit() {
        if (!capturedPhotoBlob) {
          alert("কোনো ছবি নেওয়া হয়নি!");
          return;
        }
        await updateClassWiseReport();
        const loadingOverlay = document.getElementById("loadingOverlay");
        const submitBtn = document.getElementById("submitBtn");
        const cameraModal = document.getElementById("cameraModal");
        cameraModal.classList.remove("show");
        loadingOverlay.classList.remove("hidden");
        loadingOverlay.classList.add("show");
        submitBtn.disabled = true;
        submitBtn.textContent = "জমা হচ্ছে...";
        try {
          await submitAttendanceToGoogleSheets();
          let totalStudents = 0;
          let presentStudents = 0;
          let absentStudents = 0;
          let absentStudentsList = [];
          floorRooms.forEach((room) => {
            if (studentsData[room]) {
              studentsData[room].forEach((student) => {
                totalStudents++;
                if (attendance[student.reg] === "present") {
                  presentStudents++;
                } else {
                  absentStudents++;
                  absentStudentsList.push({
                    name: student.name,
                    reg: student.reg,
                    room: room,
                    class: student.class,
                  });
                }
              });
            }
          });
          const floorSelect = document.getElementById("floorSelect");
          const selectedFloorLabel =
            floorSelect.options[floorSelect.selectedIndex].text;
          let absentStudentsText = "";
          if (absentStudentsList.length > 0) {
            absentStudentsText = `\n\n❌ অনুপস্থিত শিক্ষার্থীরা (${absentStudents} জন):\n`;
            absentStudentsList.forEach((student, index) => {
              absentStudentsText += `${index + 1}. ${student.name} (Reg: ${
                student.reg
              }, Room: ${student.room}, Class: ${student.class})\n`;
            });
          } else {
            absentStudentsText = `\n\n✅ সবাই হাজির!`;
          }
          const locationStatus =
            staffLocation.distance !== "Unknown" &&
            !isNaN(staffLocation.distance) &&
            staffLocation.distance <= 500
              ? "✅ সঠিক স্থানে"
              : "⚠️ দূরে অবস্থান";
          const caption = `📋 Al Ameen Mission Academy Nayabaz Attendance
📅 Date: ${serverDate}
👨‍🏫 Staff: ${staffName}
🏢 Floor: ${selectedFloorLabel}
👥 মোট শিক্ষার্থী: ${totalStudents} জন
✅ হাজির: ${presentStudents} জন
❌ অনুপস্থিত: ${absentStudents} জন${absentStudentsText}

📍 Location Info:
🌍 Latitude: ${staffLocation.lat}
🌍 Longitude: ${staffLocation.lon}
📏 Distance from Academy: ${staffLocation.distance} meters ${locationStatus}
🗺️ Google Maps: https://maps.google.com/?q=${staffLocation.lat},${staffLocation.lon}`;
          const photoSent = await sendPhotoToTelegram(
            capturedPhotoBlob,
            caption
          );
          if (photoSent) {
            closeCameraModal();
            alert("অ্যাটেনডেন্স সফলভাবে জমা হয়েছে!");
            setTimeout(() => {
              document
                .getElementById("attendanceSystem")
                .classList.add("hidden");
              document.getElementById("loginScreen").classList.remove("hidden");
              document.getElementById("staffIdInput").value = "";
              document.getElementById("staffPasswordInput").value = "";
              document.getElementById("staffNameInput").value = "";
              document.getElementById("floorSelect").value = "";
              attendance = {};
              currentRoomIndex = 0;
              highlightedStudent = null;
              staffName = "";
              selectedFloor = "";
              floorRooms = [];
              studentsData = {};
              serverDate = "";
              staffLocation = { lat: null, lon: null, distance: null };
              updateProgress();
            }, 500);
          } else {
            throw new Error("Failed to send photo to Telegram");
          }
        } catch (error) {
          console.error("Error in photo submission:", error);
          alert(
            "অ্যাটেনডেন্স জমা দিতে ব্যর্থ হয়েছে। অনুগ্রহ করে আবার চেষ্টা করুন।"
          );
        } finally {
          loadingOverlay.classList.remove("show");
          loadingOverlay.classList.add("hidden");
          submitBtn.disabled = false;
          submitBtn.textContent = "📸 ছবি তুলে অ্যাটেনডেন্স জমা দিন";
        }
      }

      async function startAttendance() {
        const staffId = document.getElementById("staffIdInput").value.trim();
        const staffPassword = document
          .getElementById("staffPasswordInput")
          .value.trim();
        const floor = document.getElementById("floorSelect").value;
        const loginButton = document.querySelector(".login-box button");
        const loadingOverlay = document.getElementById("loadingOverlay");
        loadingOverlay.classList.remove("hidden");
        loadingOverlay.classList.add("show");
        loginButton.disabled = true;
        if (!staffId || !staffPassword) {
          alert("অনুগ্রহ করে ID ও Password দিন।");
          loadingOverlay.classList.remove("show");
          loginButton.disabled = false;
          return;
        }
        if (!(staffId in staffCredentials)) {
          alert("এই ID পাওয়া যায়নি!");
          loadingOverlay.classList.remove("show");
          loginButton.disabled = false;
          return;
        }
        if (staffCredentials[staffId].password !== staffPassword) {
          alert("Password ভুল!");
          loadingOverlay.classList.remove("show");
          loginButton.disabled = false;
          return;
        }
        try {
          staffLocation = await getUserLocation();
          const staffNameFromCredentials = staffCredentials[staffId].name;
          const deviceVerification = await verifyDeviceAccess(
            staffId,
            staffNameFromCredentials,
            staffLocation
          );
          if (deviceVerification.status === "error") {
            alert(deviceVerification.message);
            loadingOverlay.classList.remove("show");
            loginButton.disabled = false;
            return;
          }
          if (
            deviceVerification.message &&
            deviceVerification.message.includes("registered successfully")
          ) {
            console.log("Device registered:", deviceVerification.message);
          }
        } catch (error) {
          alert("Device verification failed. Please try again.");
          loadingOverlay.classList.remove("show");
          loginButton.disabled = false;
          return;
        }
        if (!floor) {
          alert("অনুগ্রহ করে একটি ফ্লোর নির্বাচন করুন।");
          loadingOverlay.classList.remove("show");
          loginButton.disabled = false;
          return;
        }
        staffName = staffCredentials[staffId].name;
        selectedFloor = floor;
        try {
          const studentResponse = await fetch(
            `${WEB_APP_URL}?action=getStudentsByFloor&floor=${selectedFloor}`
          );
          if (!studentResponse.ok)
            throw new Error(`HTTP error! status: ${studentResponse.status}`);
          const studentData = await studentResponse.json();
          if (Object.keys(studentData).length === 0) {
            alert("এই ফ্লোরের জন্য কোনো শিক্ষার্থীর ডেটা পাওয়া যায়নি।");
            loadingOverlay.classList.remove("show");
            loginButton.disabled = false;
            return;
          }
          studentsData = studentData;
          floorRooms = Object.keys(studentsData).sort(
            (a, b) => parseInt(a) - parseInt(b)
          );
          const dateResponse = await fetch(
            `${WEB_APP_URL}?action=getCurrentDate`
          );
          if (!dateResponse.ok)
            throw new Error(`HTTP error! status: ${dateResponse.status}`);
          const dateData = await dateResponse.json();
          serverDate = dateData.date;
          document.getElementById("loginScreen").classList.add("hidden");
          document
            .getElementById("attendanceSystem")
            .classList.remove("hidden");
          initAttendanceSystem();
        } catch (error) {
          alert("ডেটা লোড করতে ব্যর্থ হয়েছে।\n" + error.message);
        } finally {
          loadingOverlay.classList.remove("show");
          loginButton.disabled = false;
        }
      }

      // FIXED: calculateClassWiseData function to properly handle floor-specific data
      function calculateClassWiseData() {
        classWiseData = {};
        const floorSelect = document.getElementById("floorSelect");
        const currentFloorLabel =
          floorSelect.options[floorSelect.selectedIndex].text;

        floorRooms.forEach((room) => {
          if (studentsData[room]) {
            studentsData[room].forEach((student) => {
              const className = student.class;
              const status = attendance[student.reg] || "present";

              // Use only className as key (remove floor suffix)
              if (!classWiseData[className]) {
                classWiseData[className] = {
                  className: className,
                  floorId: selectedFloor,
                  floorLabel: currentFloorLabel,
                  total: 0,
                  present: 0,
                  absent: 0,
                  attendanceTaken: true, // Set to true since we're taking attendance
                };
              }

              classWiseData[className].total++;

              if (status === "present") {
                classWiseData[className].present++;
              } else {
                classWiseData[className].absent++;
              }
            });
          }
        });
      }

      async function getTodaysClassReport() {
        try {
          const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/getChat`;
          const response = await fetch(url, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              chat_id: TELEGRAM_CHAT_ID,
            }),
          });
          const result = await response.json();
          if (result.ok && result.result.pinned_message) {
            const pinnedMessage = result.result.pinned_message;
            const currentDate = serverDate;
            if (
              pinnedMessage.text &&
              pinnedMessage.text.includes(`📅 ${currentDate}`)
            ) {
              return {
                messageId: pinnedMessage.message_id,
                text: pinnedMessage.text,
                isForToday: true,
              };
            } else {
              return {
                messageId: pinnedMessage.message_id,
                text: pinnedMessage.text,
                isForToday: false,
              };
            }
          }
          return null;
        } catch (error) {
          console.error("Error getting today's report:", error);
          return null;
        }
      }

      // FIXED: parseExistingClassData to handle floor-specific classes
      function parseExistingClassData(messageText) {
        const existingData = {};

        // Pattern to match class data in the message
        const classPattern =
          /📚\s+([^:]+):\s*(\d+)\/(\d+)\s*\((\d+)\s*অনুপস্থিত\)/g;
        let match;

        while ((match = classPattern.exec(messageText)) !== null) {
          const className = match[1].trim();
          const present = parseInt(match[2]);
          const total = parseInt(match[3]);
          const absent = parseInt(match[4]);

          existingData[className] = {
            total: total,
            present: present,
            absent: absent,
            attendanceTaken: total > 0, // If total > 0, attendance has been taken
          };
        }

        return existingData;
      }

      function parseExistingFloorData(messageText) {
        const existingFloorData = {};
        const floorPattern =
          /🔹\s*(.+?):\s*👥\s*(\d+)\/(\d+)\s*\((\d+\.?\d*)%\)\s*👨‍🏫\s*(.+?)\s*-\s*(.+)/g;
        let match;

        while ((match = floorPattern.exec(messageText)) !== null) {
          const floorName = match[1].trim();
          const present = parseInt(match[2]);
          const total = parseInt(match[3]);
          const percentage = match[4];
          const staffName = match[5].trim();
          const time = match[6].trim();

          existingFloorData[floorName] = {
            total: total,
            present: present,
            absent: total - present,
            percentage: percentage,
            completedBy: staffName,
            completedAt: time,
            classes: {}, // This will be populated separately if needed
          };
        }

        return existingFloorData;
      }

      // FIXED: updateClassWiseReport function with proper class aggregation
      async function updateClassWiseReport() {
        try {
          calculateClassWiseData();
          const existingReport = await getTodaysClassReport();
          let existingFloorData = {};
          let existingClassData = {};
          let shouldCreateNewMessage = true;
          let messageIdToUpdate = null;

          if (existingReport) {
            if (
              existingReport.text &&
              existingReport.text.includes(`📅 ${serverDate}`)
            ) {
              shouldCreateNewMessage = false;
              messageIdToUpdate = existingReport.messageId;
              existingFloorData = parseExistingFloorData(existingReport.text);
              existingClassData = parseExistingClassData(existingReport.text);
              console.log("Found existing report for today, will update it");
            } else {
              try {
                await unpinTelegramMessage();
                console.log("Unpinned old message for different date");
              } catch (error) {
                console.error("Error unpinning old message:", error);
              }
              shouldCreateNewMessage = true;
            }
          }

          const floorSelect = document.getElementById("floorSelect");
          const currentFloorLabel =
            floorSelect.options[floorSelect.selectedIndex].text;

          let floorTotal = 0;
          let floorPresent = 0;
          floorRooms.forEach((room) => {
            if (studentsData[room]) {
              studentsData[room].forEach((student) => {
                floorTotal++;
                if (attendance[student.reg] === "present") {
                  floorPresent++;
                }
              });
            }
          });

          // Update floor data
          existingFloorData[currentFloorLabel] = {
            total: floorTotal,
            present: floorPresent,
            absent: floorTotal - floorPresent,
            percentage: ((floorPresent / floorTotal) * 100).toFixed(1),
            completedBy: staffName,
            completedAt: new Date().toLocaleTimeString("bn-BD"),
          };

          // FIXED: Proper class data aggregation
          // First, update existing class data with current floor's class data
          Object.keys(classWiseData).forEach((className) => {
            const currentClassData = classWiseData[className];

            if (existingClassData[className]) {
              // If class already exists, we need to update it properly
              // Remove the previous contribution from this floor and add new data
              existingClassData[className] = {
                total:
                  existingClassData[className].total -
                  (existingClassData[className][currentFloorLabel]
                    ? existingClassData[className][currentFloorLabel].total
                    : 0) +
                  currentClassData.total,
                present:
                  existingClassData[className].present -
                  (existingClassData[className][currentFloorLabel]
                    ? existingClassData[className][currentFloorLabel].present
                    : 0) +
                  currentClassData.present,
                absent:
                  existingClassData[className].absent -
                  (existingClassData[className][currentFloorLabel]
                    ? existingClassData[className][currentFloorLabel].absent
                    : 0) +
                  currentClassData.absent,
                attendanceTaken: true,
              };
            } else {
              // New class data
              existingClassData[className] = {
                total: currentClassData.total,
                present: currentClassData.present,
                absent: currentClassData.absent,
                attendanceTaken: currentClassData.attendanceTaken,
              };
            }

            // Store floor-specific data for future reference
            if (!existingClassData[className].floors) {
              existingClassData[className].floors = {};
            }
            existingClassData[className].floors[currentFloorLabel] = {
              total: currentClassData.total,
              present: currentClassData.present,
              absent: currentClassData.absent,
            };
          });

          // Initialize default classes if they don't exist
          ["XI", "XII", "NEET"].forEach((className) => {
            if (!existingClassData[className]) {
              existingClassData[className] = {
                total: 0,
                present: 0,
                absent: 0,
                attendanceTaken: false,
                floors: {},
              };
            }
          });

          const today = serverDate;
          const todayBangla = new Date().toLocaleDateString("bn-BD", {
            weekday: "long",
            year: "numeric",
            month: "long",
            day: "numeric",
          });

          let reportMessage = `📅 ${today}\n🗓️ ${todayBangla}\n\n📊 আজকের ক্লাসওয়াইজ হাজিরা রিপোর্ট:\n\n`;

          // Custom sorting with XI, XII, NEET at the top
          const sortedClasses = Object.keys(existingClassData).sort((a, b) => {
            const priorityOrder = { XI: 1, XII: 2, NEET: 3 };

            if (priorityOrder[a] && priorityOrder[b]) {
              return priorityOrder[a] - priorityOrder[b];
            } else if (priorityOrder[a]) {
              return -1;
            } else if (priorityOrder[b]) {
              return 1;
            }

            const getNumFromClass = (className) => {
              const match = className.match(/\d+/);
              return match ? parseInt(match[0]) : 0;
            };
            return getNumFromClass(a) - getNumFromClass(b);
          });

          // Display class data without floor information
          sortedClasses.forEach((className) => {
            const data = existingClassData[className];
            const percentage =
              data.total > 0
                ? ((data.present / data.total) * 100).toFixed(1)
                : "0.0";
            const status = data.attendanceTaken
              ? "✅ নেওয়া হয়েছে"
              : "⏳ বাকি";

            reportMessage += `📚 ${className}: ${data.present}/${data.total} (${data.absent} অনুপস্থিত) - ${percentage}% ${status}\n`;
          });

          // Calculate overall statistics from floor data
          let totalStudentsFromFloors = 0;
          let totalPresentFromFloors = 0;
          let totalAbsentFromFloors = 0;
          Object.keys(existingFloorData).forEach((floorName) => {
            const floorData = existingFloorData[floorName];
            totalStudentsFromFloors += floorData.total;
            totalPresentFromFloors += floorData.present;
            totalAbsentFromFloors += floorData.absent;
          });

          const overallPercentage =
            totalStudentsFromFloors > 0
              ? (
                  (totalPresentFromFloors / totalStudentsFromFloors) *
                  100
                ).toFixed(1)
              : "0.0";

          reportMessage += `\n📈 সামগ্রিক পরিসংখ্যান:\n`;
          reportMessage += `👥 মোট শিক্ষার্থী: ${totalStudentsFromFloors} জন\n`;
          reportMessage += `✅ হাজির: ${totalPresentFromFloors} জন\n`;
          reportMessage += `❌ অনুপস্থিত: ${totalAbsentFromFloors} জন\n`;
          reportMessage += `📊 হাজিরার হার: ${overallPercentage}%\n\n`;

          reportMessage += `🏢 ফ্লোরওয়াইজ রিপোর্ট:\n`;
          Object.keys(existingFloorData).forEach((floorName) => {
            const floorData = existingFloorData[floorName];
            reportMessage += `🔹 ${floorName}:\n`;
            reportMessage += `   👥 ${floorData.present}/${floorData.total} (${floorData.percentage}%)\n`;
            reportMessage += `   👨‍🏫 ${floorData.completedBy} - ${floorData.completedAt}\n\n`;
          });

          reportMessage += `🕐 সর্বশেষ আপডেট: ${new Date().toLocaleTimeString(
            "bn-BD"
          )}\n`;

          if (shouldCreateNewMessage) {
            console.log("Creating new message for date:", serverDate);
            const sendResult = await sendTelegramMessage(reportMessage);
            if (sendResult && sendResult.ok) {
              await pinTelegramMessage(sendResult.result.message_id);
              console.log(
                `Created and pinned new message for date: ${serverDate}`
              );
            }
          } else {
            console.log("Updating existing message for date:", serverDate);
            await editTelegramMessage(messageIdToUpdate, reportMessage);
            console.log(
              `Updated existing pinned message for date: ${serverDate}`
            );
          }
        } catch (error) {
          console.error("Error updating class-wise report:", error);
        }
      }

      async function unpinTelegramMessage() {
        const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/unpinChatMessage`;
        const response = await fetch(url, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            chat_id: TELEGRAM_CHAT_ID,
          }),
        });
        return response.json();
      }

      async function sendTelegramMessage(text) {
        const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;
        const response = await fetch(url, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            chat_id: TELEGRAM_CHAT_ID,
            text: text,
            parse_mode: "HTML",
          }),
        });
        return response.json();
      }

      async function editTelegramMessage(messageId, text) {
        const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/editMessageText`;
        const response = await fetch(url, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            chat_id: TELEGRAM_CHAT_ID,
            message_id: messageId,
            text: text,
            parse_mode: "HTML",
          }),
        });
        return response.json();
      }

      async function pinTelegramMessage(messageId) {
        const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/pinChatMessage`;
        const response = await fetch(url, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            chat_id: TELEGRAM_CHAT_ID,
            message_id: messageId,
            disable_notification: false,
          }),
        });
        return response.json();
      }

      function initializeDateSelectors() {
        const daySelect = document.getElementById("daySelect");
        const monthSelect = document.getElementById("monthSelect");
        const yearSelect = document.getElementById("yearSelect");
        const parts = serverDate.split("/");
        const day = parts[0];
        const month = parseInt(parts[1]) - 1;
        const year = parts[2];
        const dateObj = new Date(year, month, day);
        daySelect.innerHTML = `<option value="${day}">${day}</option>`;
        monthSelect.innerHTML = `<option value="${
          month + 1
        }">${dateObj.toLocaleString("en-US", { month: "long" })}</option>`;
        yearSelect.innerHTML = `<option value="${year}">${year}</option>`;
      }

      function initializeRoomButtons() {
        const roomButtonsContainer = document.getElementById("roomButtons");
        roomButtonsContainer.innerHTML = "";
        floorRooms.forEach((room, index) => {
          if (studentsData[room]) {
            const button = document.createElement("button");
            button.className = "room-btn blast-effect";
            button.textContent = `Room ${room} (${studentsData[room].length})`;
            button.onclick = () => switchToRoom(index);
            roomButtonsContainer.appendChild(button);
          }
        });
      }

      function searchStudents() {
        const searchTerm = document
          .getElementById("searchInput")
          .value.toLowerCase();
        const searchResults = document.getElementById("searchResults");
        if (searchTerm.length < 2) {
          searchResults.innerHTML = "";
          return;
        }
        const results = [];
        floorRooms.forEach((room) => {
          if (studentsData[room]) {
            studentsData[room].forEach((student) => {
              if (
                student.name.toLowerCase().includes(searchTerm) ||
                student.reg.toLowerCase().includes(searchTerm)
              ) {
                results.push({ ...student, room });
              }
            });
          }
        });
        searchResults.innerHTML = "";
        results.forEach((student) => {
          const resultItem = document.createElement("div");
          resultItem.className = "search-result-item";
          resultItem.innerHTML = `
            <div class="search-result-name">${student.name}</div>
            <div class="search-result-details">Reg: ${student.reg} | Room: ${student.room} | Class: ${student.class}</div>
          `;
          resultItem.onclick = () => selectStudent(student);
          searchResults.appendChild(resultItem);
        });
      }

      function selectStudent(student) {
        const roomIndex = floorRooms.indexOf(student.room);
        if (roomIndex !== -1) {
          switchToRoom(roomIndex);
          highlightedStudent = student.reg;
          document.getElementById("searchInput").value = "";
          document.getElementById("searchResults").innerHTML = "";
          setTimeout(() => {
            highlightedStudent = null;
            updateRoomDisplay();
          }, 2000);
        }
      }

      function switchToRoom(index) {
        currentRoomIndex = index;
        updateRoomDisplay();
        updateNavigationButtons();
        updateRoomButtons();
      }

      function navigateRoom(direction) {
        const newIndex = currentRoomIndex + direction;
        if (newIndex >= 0 && newIndex < floorRooms.length) {
          switchToRoom(newIndex);
        }
      }

      function updateRoomDisplay() {
        const currentRoom = floorRooms[currentRoomIndex];
        const students = studentsData[currentRoom];
        if (!students) {
          document.getElementById(
            "roomTitle"
          ).textContent = `Room ${currentRoom} - No Data`;
          document.getElementById("studentList").innerHTML =
            "<p style='text-align: center; color: #6c757d;'>এই রুমে কোনো শিক্ষার্থীর ডেটা পাওয়া যায়নি।</p>";
          updateStats();
          return;
        }
        const roomClass = students.length > 0 ? students[0].class : "N/A";
        document.getElementById(
          "roomTitle"
        ).textContent = `Room ${currentRoom} - ${roomClass}`;
        const studentListContainer = document.getElementById("studentList");
        studentListContainer.innerHTML = "";
        students.forEach((student) => {
          const studentCard = document.createElement("div");
          const attendanceStatus = attendance[student.reg] || "present";
          studentCard.className = `student-card ${attendanceStatus}`;
          if (highlightedStudent === student.reg) {
            studentCard.classList.add("highlighted");
          }
          studentCard.innerHTML = `
            <div class="student-info">
              <div>
                <div class="student-name">${student.name}</div>
                <div class="student-reg">Reg: ${student.reg} | Class: ${
            student.class
          }</div>
              </div>
              <div class="attendance-status">
                <div class="status-indicator ${
                  attendanceStatus === "present"
                    ? "status-present"
                    : "status-absent"
                }">
                  ${attendanceStatus === "present" ? "✓ হাজির" : "✗ অনুপস্থিত"}
                </div>
                <button class="toggle-btn blast-effect ${
                  attendanceStatus === "present"
                    ? "toggle-absent"
                    : "toggle-present"
                }"
                        onclick="toggleAttendance('${student.reg}')">
                  ${
                    attendanceStatus === "present"
                      ? "অনুপস্থিত করুন"
                      : "হাজির করুন"
                  }
                </button>
              </div>
            </div>
          `;
          studentListContainer.appendChild(studentCard);
        });
        updateStats();
      }

      function toggleAttendance(regNumber) {
        const currentStatus = attendance[regNumber] || "present";
        attendance[regNumber] =
          currentStatus === "present" ? "absent" : "present";
        updateRoomDisplay();
        updateProgress();
      }

      function markAllPresent() {
        const currentRoom = floorRooms[currentRoomIndex];
        if (studentsData[currentRoom]) {
          studentsData[currentRoom].forEach((student) => {
            attendance[student.reg] = "present";
          });
        }
        updateRoomDisplay();
        updateProgress();
      }

      function updateNavigationButtons() {
        const prevBtn = document.getElementById("prevBtn");
        const nextBtn = document.getElementById("nextBtn");
        prevBtn.disabled = currentRoomIndex === 0;
        nextBtn.disabled = currentRoomIndex === floorRooms.length - 1;
      }

      function updateRoomButtons() {
        const roomButtons = document.querySelectorAll(".room-btn");
        roomButtons.forEach((button, index) => {
          button.classList.toggle("active", index === currentRoomIndex);
        });
      }

      function updateStats() {
        const currentRoom = floorRooms[currentRoomIndex];
        const students = studentsData[currentRoom];
        let presentCount = 0;
        let absentCount = 0;
        let totalStudentsInRoom = 0;
        if (students) {
          totalStudentsInRoom = students.length;
          students.forEach((student) => {
            if (attendance[student.reg] === "present") {
              presentCount++;
            } else {
              absentCount++;
            }
          });
        }
        document.getElementById("presentCount").textContent = presentCount;
        document.getElementById("absentCount").textContent = absentCount;
        document.getElementById("totalCount").textContent = totalStudentsInRoom;
      }

      function updateProgress() {
        let totalStudents = 0;
        let presentStudents = 0;
        floorRooms.forEach((room) => {
          if (studentsData[room]) {
            studentsData[room].forEach((student) => {
              totalStudents++;
              if (attendance[student.reg] === "present") {
                presentStudents++;
              }
            });
          }
        });
        const progressPercentage =
          totalStudents > 0 ? (presentStudents / totalStudents) * 100 : 0;
        document.getElementById("progressBar").style.width =
          progressPercentage + "%";
        document.getElementById(
          "progressText"
        ).textContent = `${presentStudents} জন হাজির, ${
          totalStudents - presentStudents
        } জন অনুপস্থিত (${Math.round(progressPercentage)}% হাজির)`;
      }

      async function submitAttendance() {
        const submitBtn = document.getElementById("submitBtn");
        const loadingOverlay = document.getElementById("loadingOverlay");
        submitBtn.disabled = true;
        submitBtn.textContent = "জমা হচ্ছে...";
        loadingOverlay.classList.add("show");
        try {
          await openCameraModal();
        } catch (error) {
          console.error("Error opening camera:", error);
          alert("ক্যামেরা খুলতে সমস্যা হয়েছে।");
        } finally {
          loadingOverlay.classList.remove("show");
          submitBtn.disabled = false;
          submitBtn.textContent = "📸 ছবি তুলে অ্যাটেনডেন্স জমা দিন";
        }
      }

      async function submitAttendanceToGoogleSheets() {
        const dateToSubmit = serverDate;
        const attendanceData = [];
        floorRooms.forEach((room) => {
          if (studentsData[room]) {
            studentsData[room].forEach((student) => {
              const status = attendance[student.reg] || "present";
              attendanceData.push({
                room: room,
                reg: student.reg,
                name: student.name,
                class: student.class,
                status: status,
              });
            });
          }
        });
        const payload = {
          staffName: staffName,
          floor: selectedFloor,
          date: dateToSubmit,
          attendance: attendanceData,
        };
        const response = await fetch(WEB_APP_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(payload),
          mode: "no-cors",
        });
        await new Promise((resolve) => setTimeout(resolve, 1000));
      }

      function initializeAttendance() {
        attendance = {};
        floorRooms.forEach((room) => {
          if (studentsData[room]) {
            studentsData[room].forEach((student) => {
              if (attendance[student.reg] === undefined) {
                attendance[student.reg] = "present";
              }
            });
          }
        });
      }

      function initAttendanceSystem() {
        initializeDateSelectors();
        initializeRoomButtons();
        initializeAttendance();
        switchToRoom(0);
        updateProgress();
      }

      function addBlastEffect(event) {
        const button = event.currentTarget;
        if (!button.classList.contains("blast-effect")) {
          button.classList.add("blast-effect");
        }
        button.classList.add("active");
        button.addEventListener(
          "animationend",
          () => {
            button.classList.remove("active");
          },
          { once: true }
        );
      }

      document.addEventListener("DOMContentLoaded", () => {
        const buttonsToAnimate = document.querySelectorAll(
          ".room-btn, .nav-btn, .action-btn, .toggle-btn, .login-box button, .camera-btn, .report-close-btn"
        );
        buttonsToAnimate.forEach((button) => {
          button.addEventListener("click", addBlastEffect);
        });
        document
          .getElementById("captureBtn")
          .addEventListener("click", addBlastEffect);
        document
          .getElementById("retakeBtn")
          .addEventListener("click", addBlastEffect);
        document
          .getElementById("sendBtn")
          .addEventListener("click", addBlastEffect);
      });

      function openAttendanceReport() {
        const modal = document.getElementById("reportModal");
        const iframe = document.getElementById("reportIframe");
        iframe.src = "attendence report.html";
        modal.classList.add("show");
      }

      function closeAttendanceReport() {
        const modal = document.getElementById("reportModal");
        const iframe = document.getElementById("reportIframe");
        modal.classList.remove("show");
        setTimeout(() => {
          iframe.src = "";
        }, 300);
      }

      document.addEventListener("DOMContentLoaded", function () {
        const modal = document.getElementById("reportModal");
        modal.addEventListener("click", function (e) {
          if (e.target === modal) {
            closeAttendanceReport();
          }
        });
        document.addEventListener("keydown", function (e) {
          if (e.key === "Escape" && modal.classList.contains("show")) {
            closeAttendanceReport();
          }
        });
      });
    </script>
  </body>
</html>
