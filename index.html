<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Al Ameen Mission Academy Nayabaz Attendance Tracker</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Google Fonts - Poppins for a more modern look -->
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      /* Existing CSS styles remain here */
      .logo {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        margin: 0 auto 10px;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      }

      .room-buttons-wrapper {
        overflow-x: auto;
        padding-bottom: 5px;
        scrollbar-width: none;
        -ms-overflow-style: none;
      }
      .room-buttons-wrapper::-webkit-scrollbar {
        display: none;
      }

      @media (max-width: 480px) {
        .room-btn {
          font-size: 11px;
          padding: 8px 10px;
          white-space: nowrap;
        }
      }

      .room-buttons {
        display: flex;
        gap: 10px;
        flex-wrap: nowrap;
        min-width: max-content;
      }

      /* --- NEW: Blast Effect CSS --- */
      .blast-effect {
        position: relative;
        overflow: hidden;
        z-index: 1; /* Ensure the blast is above other content */
      }

      .blast-effect::before {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        background: radial-gradient(
          circle,
          rgba(255, 255, 255, 0.8) 0%,
          rgba(255, 255, 255, 0) 70%
        );
        border-radius: 50%;
        opacity: 0;
        transform: translate(-50%, -50%);
        transition: none; /* Reset transition for immediate effect */
        pointer-events: none; /* Allow clicks to pass through */
        z-index: 2;
      }

      .blast-effect.active::before {
        animation: blast 0.4s ease-out forwards;
      }

      @keyframes blast {
        0% {
          width: 0;
          height: 0;
          opacity: 0.8;
        }
        100% {
          width: 200%; /* Expand beyond button size */
          height: 200%;
          opacity: 0;
        }
      }
      /* --- END NEW: Blast Effect CSS --- */

      .nav-btn {
        padding: 10px 20px;
        border: none;
        border-radius: 20px;
        background: linear-gradient(135deg, #0f4c75 0%, #3282b8 100%);
        color: white;
        font-size: 14px;
        font-weight: bold;
        box-shadow: 0 4px 8px rgba(15, 76, 117, 0.3);
        transition: all 0.3s ease;
      }
      .nav-btn:hover:not(:disabled) {
        transform: translateY(-3px); /* Enhanced hover */
        background: linear-gradient(135deg, #3282b8 0%, #0f4c75 100%);
        box-shadow: 0 6px 12px rgba(15, 76, 117, 0.4);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Poppins", sans-serif; /* Updated font */
        background: linear-gradient(
          135deg,
          #0f4c75 0%,
          #3282b8 50%,
          #bbe1fa 100%
        );
        min-height: 100vh;
        padding: 10px;
      }

      .container {
        max-width: 400px;
        margin: 0 auto;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #0f4c75 0%, #3282b8 100%);
        padding: 20px;
        text-align: center;
        color: white;
        position: relative;
        overflow: hidden;
      }

      .header::before {
        content: "";
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="islamic-pattern" x="0" y="0" width="20" height="20" patternUnits="userSpaceOnUse"><circle cx="10" cy="10" r="2" fill="rgba(255,255,255,0.1)"/><path d="M10 5 L15 10 L10 15 L5 10 Z" fill="rgba(255,255,255,0.05)"/></pattern></defs><rect width="100" height="100" fill="url(%23islamic-pattern)"/></svg>')
          repeat;
        z-index: 1;
      }

      .header-content {
        position: relative;
        z-index: 2;
      }

      .logo {
        width: 60px;
        height: 60px;
        background: linear-gradient(135deg, #ffd700 0%, #ffa500 100%);
        border-radius: 50%;
        margin: 0 auto 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
        border: 3px solid rgba(255, 255, 255, 0.3);
      }

      /* --- NEW: Logo Animation CSS --- */
      .logo-animation-container {
        /* This container will hide the overflow and apply the animation */
        overflow: hidden; /* Crucial for the slide-up effect */
        height: 80px; /* ‡¶¨‡¶æ‡¶°‡¶º‡¶æ‡¶®‡ßã ‡¶π‡¶≤ */
        margin-bottom: 10px; /* Match the height of your .logo */
        margin: 0 auto 10px; /* Inherit margin from .logo */
        display: flex; /* To center the logo within it */
        align-items: flex-end; /* Start logo at the bottom of the container */
        justify-content: center;
      }

      .logo-animation-container .logo {
        /* Apply animation to the actual logo element */
        animation: logoSlideUpFadeIn 1s ease-out forwards; /* 1 second duration, smooth ease-out */
        transform: translateY(
          100%
        ); /* Start completely below its final position */
        opacity: 0; /* Start invisible */
      }

      @keyframes logoSlideUpFadeIn {
        0% {
          transform: translateY(100%); /* Start from below */
          opacity: 0; /* Start invisible */
        }
        60% {
          opacity: 1; /* Fade in quickly */
        }
        100% {
          transform: translateY(0); /* End at its natural position */
          opacity: 1; /* Fully visible */
        }
      }
      /* --- END NEW: Logo Animation CSS --- */

      .header h1 {
        font-size: 1.3rem;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        font-weight: 600;
      }

      .date-selector {
        background: rgba(255, 255, 255, 0.2);
        padding: 15px;
        border-radius: 10px;
        margin-top: 10px;
      }

      .date-inputs {
        display: flex;
        gap: 10px;
        justify-content: center;
      }

      .date-inputs select {
        padding: 8px;
        border: none;
        border-radius: 5px;
        background: white;
        font-size: 14px;
      }

      .room-nav {
        padding: 20px;
        background: #f8f9fa;
        border-bottom: 1px solid #e9ecef;
      }

      .room-buttons {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: center;
        margin-bottom: 15px;
      }

      .room-btn {
        padding: 10px 15px;
        border: none;
        border-radius: 20px;
        background: #e9ecef;
        color: #495057;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 12px;
      }

      .room-btn.active {
        background: linear-gradient(135deg, #0f4c75 0%, #3282b8 100%);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(15, 76, 117, 0.4);
      }

      .navigation {
        display: flex;
        justify-content: space-between;
        margin-top: 15px;
      }

      .nav-btn {
        padding: 8px 16px;
        border: none;
        border-radius: 15px;
        background: #6c757d;
        color: white;
        cursor: pointer;
        font-size: 12px;
      }

      .nav-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .search-section {
        padding: 20px;
        background: #f8f9fa;
        border-bottom: 1px solid #e9ecef;
      }

      .search-input {
        width: 100%;
        padding: 12px;
        border: 2px solid #e9ecef;
        border-radius: 10px;
        font-size: 14px;
        transition: border-color 0.3s ease;
      }

      .search-input:focus {
        outline: none;
        border-color: #3282b8;
        box-shadow: 0 0 10px rgba(50, 130, 184, 0.2);
      }

      .search-results {
        margin-top: 10px;
        max-height: 200px;
        overflow-y: auto;
      }

      .search-result-item {
        padding: 10px;
        background: white;
        border-radius: 8px;
        margin-bottom: 5px;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 1px solid #e9ecef;
      }

      .search-result-item:hover {
        background: #f8f9fa;
        transform: translateY(-1px);
      }

      .search-result-name {
        font-weight: 600;
        color: #495057;
        font-size: 14px;
      }

      .search-result-details {
        color: #6c757d;
        font-size: 12px;
      }

      .content {
        padding: 20px;
        max-height: 60vh;
        overflow-y: auto;
      }

      .room-title {
        text-align: center;
        margin-bottom: 20px;
        color: #495057;
        font-size: 1.2rem;
        font-weight: 600;
      }

      .student-card {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 15px;
        margin-bottom: 10px;
        border: 2px solid transparent;
        transition: all 0.3s ease;
      }

      .student-card:hover {
        transform: translateY(-3px); /* Enhanced hover */
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15); /* Enhanced shadow */
      }

      .student-card.present {
        border-color: #0f4c75;
        background: linear-gradient(135deg, #e8f4fd 0%, #d1e7f0 100%);
        border-left: 4px solid #0f4c75;
      }

      .student-card.absent {
        border-color: #dc3545;
        background: linear-gradient(135deg, #fff5f5 0%, #fed7d7 100%);
        border-left: 4px solid #dc3545;
      }

      .student-card.highlighted {
        border-color: #ffd700;
        background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
        border-left: 4px solid #ffd700;
        animation: highlight 1s ease-in-out;
      }

      @keyframes highlight {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
        100% {
          transform: scale(1);
        }
      }

      .student-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .student-name {
        font-weight: 600;
        color: #495057;
        font-size: 14px;
      }

      .student-reg {
        color: #6c757d;
        font-size: 12px;
      }

      .attendance-status {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .status-indicator {
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 12px;
        font-weight: 600;
      }

      .status-present {
        background: linear-gradient(135deg, #0f4c75 0%, #3282b8 100%);
        color: white;
        border-radius: 15px;
        padding: 5px 12px;
        font-size: 11px;
        font-weight: 600;
        box-shadow: 0 2px 4px rgba(15, 76, 117, 0.3);
      }

      .status-absent {
        background: #dc3545;
        color: white;
      }

      .toggle-btn {
        padding: 5px 10px;
        border: none;
        border-radius: 15px;
        cursor: pointer;
        font-size: 12px;
        font-weight: 600;
        transition: all 0.3s ease;
      }

      .toggle-present {
        background: linear-gradient(135deg, #0f4c75 0%, #3282b8 100%);
        color: white;
        border-radius: 15px;
        padding: 5px 12px;
        font-size: 11px;
        box-shadow: 0 2px 4px rgba(15, 76, 117, 0.3);
      }

      .toggle-absent {
        background: #dc3545;
        color: white;
      }

      .actions {
        padding: 20px;
        background: #f8f9fa;
        border-top: 1px solid #e9ecef;
      }

      .action-btn {
        width: 100%;
        padding: 12px;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 10px;
        transition: all 0.3s ease;
      }

      .mark-all-btn {
        background: linear-gradient(135deg, #0f4c75 0%, #3282b8 100%);
        color: white;
        margin-bottom: 10px;
        box-shadow: 0 4px 8px rgba(15, 76, 117, 0.3);
      }

      .mark-all-btn:hover {
        background: linear-gradient(135deg, #3282b8 0%, #0f4c75 100%);
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(15, 76, 117, 0.4);
      }

      .export-btn {
        background: linear-gradient(135deg, #ffd700 0%, #ffa500 100%);
        color: #0f4c75;
        font-weight: bold;
        box-shadow: 0 4px 8px rgba(255, 215, 0, 0.3);
      }

      .export-btn:hover:not(:disabled) {
        background: linear-gradient(135deg, #ffa500 0%, #ffd700 100%);
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(255, 215, 0, 0.4);
      }

      .export-btn:disabled {
        background: #6c757d;
        cursor: not-allowed;
      }

      .progress {
        margin-top: 15px;
        background: #e9ecef;
        border-radius: 10px;
        height: 8px;
        overflow: hidden;
      }

      .progress-bar {
        height: 100%;
        background: linear-gradient(135deg, #0f4c75 0%, #3282b8 100%);
        transition: width 0.3s ease;
        border-radius: 10px;
      }

      .progress-text {
        text-align: center;
        margin-top: 5px;
        font-size: 12px;
        color: #6c757d;
      }

      .stats {
        display: flex;
        justify-content: space-around;
        margin-bottom: 15px;
        padding: 10px;
        background: white;
        border-radius: 10px;
      }

      .stat-item {
        text-align: center;
      }

      .stat-number {
        font-size: 18px;
        font-weight: bold;
        color: #495057;
      }

      .stat-label {
        font-size: 12px;
        color: #6c757d;
      }

      .stat-present {
        color: #0f4c75;
        font-weight: bold;
      }

      .stat-absent {
        color: #dc3545;
      }

      /* New styles for login screen */
      .login-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        padding: 20px;
        background: linear-gradient(
          135deg,
          #0f4c75 0%,
          #3282b8 50%,
          #bbe1fa 100%
        );
      }

      .login-box {
        background: white;
        padding: 40px;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        text-align: center;
        width: 100%;
        max-width: 350px;
        min-height: 550px;
        position: relative;
        position: absolute;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
      }

      .login-box h2 {
        color: #0f4c75;
        margin-bottom: 20px;
        font-size: 1.5rem;
      }

      .login-box input,
      .login-box select {
        width: calc(100% - 20px);
        padding: 12px;
        margin-bottom: 15px;
        border: 1px solid #e9ecef;
        border-radius: 10px;
        font-size: 16px;
      }

      .login-box input:focus,
      .login-box select:focus {
        outline: none;
        border-color: #3282b8;
        box-shadow: 0 0 0 3px rgba(50, 130, 184, 0.2); /* Enhanced focus */
      }

      .login-box button {
        width: 100%;
        padding: 12px;
        border: none;
        border-radius: 10px;
        background: linear-gradient(135deg, #0f4c75 0%, #3282b8 100%);
        color: white;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .login-box button:hover {
        background: linear-gradient(135deg, #3282b8 0%, #0f4c75 100%);
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(15, 76, 117, 0.4);
      }

      .hidden {
        display: none !important;
      }

      @media (max-width: 480px) {
        .container {
          margin: 0;
          border-radius: 0;
          min-height: 100vh;
        }

        .date-inputs {
          flex-direction: column;
          gap: 5px;
        }

        .date-inputs select {
          width: 100%;
        }

        .student-info {
          flex-direction: column;
          align-items: flex-start;
          gap: 10px;
        }

        .attendance-status {
          width: 100%;
          justify-content: space-between;
        }
      }

      /* --- NEW: Loading Overlay CSS (Modified) --- */
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
      }

      .loading-overlay.show {
        opacity: 1;
        visibility: visible;
      }

      .loading-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: rgba(255, 255, 255, 0.1);
        padding: 30px;
        border-radius: 20px;
        box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
      }

      .loading-logo-wrapper {
        position: relative;
        width: 100px;
        height: 100px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 20px;
        box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7);
        animation: pulse 2s infinite;
      }

      .loading-logo {
        width: 90%;
        height: 90%;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid rgba(255, 255, 255, 0.5);
      }

      @keyframes pulse {
        0% {
          box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7);
        }
        70% {
          box-shadow: 0 0 0 20px rgba(255, 215, 0, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(255, 215, 0, 0);
        }
      }

      .loading-text {
        color: white;
        font-size: 1.5rem;
        font-weight: bold;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
      }

      .loading-ring {
        border: 8px solid rgba(255, 255, 255, 0.3);
        border-top: 8px solid #ffd700;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin-top: 20px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* NEW: Camera Modal Styles */
      .camera-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
      }

      .camera-modal.show {
        opacity: 1;
        visibility: visible;
      }

      .camera-container {
        width: 90%;
        max-width: 400px;
        background: white;
        border-radius: 20px;
        padding: 20px;
        text-align: center;
      }

      .camera-video {
        width: 100%;
        max-width: 320px;
        height: 240px;
        border-radius: 10px;
        background: #000;
        margin-bottom: 20px;
        transform: scaleX(-1);
      }

      .camera-canvas {
        display: none;
      }

      .camera-controls {
        display: flex;
        gap: 10px;
        justify-content: center;
        flex-wrap: wrap;
      }

      .camera-btn {
        padding: 12px 20px;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.3s ease;
      }

      .camera-capture {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
      }

      .camera-retake {
        background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
        color: white;
      }

      .camera-cancel {
        background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%);
        color: white;
      }

      .camera-send {
        background: linear-gradient(135deg, #007bff 0%, #6610f2 100%);
        color: white;
      }

      .camera-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }

      .captured-image {
        width: 100%;
        max-width: 320px;
        height: 240px;
        border-radius: 10px;
        object-fit: cover;
        margin-bottom: 20px;
      }

      /* Attendance Report Modal Styles */
      .report-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
      }

      .report-modal.show {
        opacity: 1;
        visibility: visible;
      }

      .report-content {
        width: 95%;
        height: 95%;
        max-width: 1200px;
        background: white;
        border-radius: 20px;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .report-header {
        background: linear-gradient(135deg, #0f4c75 0%, #3282b8 100%);
        color: white;
        padding: 20px;
        text-align: center;
        position: relative;
      }

      .report-close-btn {
        position: absolute;
        right: 20px;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 20px;
        transition: all 0.3s ease;
      }

      .report-close-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: translateY(-50%) scale(1.1);
      }

      .report-iframe {
        flex: 1;
        border: none;
        width: 100%;
        height: 100%;
      }

      @media (max-width: 768px) {
        .report-content {
          width: 100%;
          height: 100%;
          border-radius: 0;
        }
      }
    </style>
  </head>
  <body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
      <div class="login-box">
        <!-- --- NEW: Logo Animation Container --- -->
        <div class="logo-animation-container">
          <div class="logo">
            <img
              src="https://play-lh.googleusercontent.com/gufR1twVlU6_SzC-iIAD_8bLLf-XYVAwwwwJF-cphD32IX0GeHNLi4GrN42hRYDHg-A"
              alt="Logo"
              style="width: 100%; height: 100%; border-radius: 50%"
            />
          </div>
        </div>
        <!-- --- END NEW: Logo Animation Container --- -->
        <h2>Staff Login</h2>

        <input
          type="text"
          id="staffIdInput"
          placeholder="Staff ID ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®"
          oninput="fillStaffName()"
        />
        <input
          type="text"
          id="staffNameInput"
          placeholder="‡¶∏‡ßç‡¶ü‡¶æ‡¶´‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ"
          disabled
        />
        <input
          type="password"
          id="staffPasswordInput"
          placeholder="‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®"
        />

        <select id="floorSelect">
          <option value="">‡¶´‡ßç‡¶≤‡ßã‡¶∞ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</option>
          <option value="old">Old Building (Room 14,15 etc.)</option>
          <option value="1">‡¶´‡ßç‡¶≤‡ßã‡¶∞ 1 (Room 101-105)</option>
          <option value="2">‡¶´‡ßç‡¶≤‡ßã‡¶∞ 2 (Room 201-205)</option>
          <option value="3">‡¶´‡ßç‡¶≤‡ßã‡¶∞ 3 (Room 301-305)</option>
          <option value="4">‡¶´‡ßç‡¶≤‡ßã‡¶∞ 4 (Room 401-404)</option>
          <option value="5">‡¶´‡ßç‡¶≤‡ßã‡¶∞ 5 (Room 501-505)</option>
          <option value="6">‡¶´‡ßç‡¶≤‡ßã‡¶∞ 6 (Room 601-605)</option>
        </select>
        <!-- Added blast-effect class -->
        <button class="blast-effect" onclick="startAttendance()">
          ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®
        </button>
        <button
          class="blast-effect"
          onclick="openAttendanceReport()"
          style="
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            margin-top: 10px;
          "
        >
          üìä Attendance Report
        </button>
      </div>
    </div>

    <!-- Main Attendance System -->
    <div id="attendanceSystem" class="container hidden">
      <div class="header">
        <div class="header-content">
          <div class="logo">
            <img
              src="https://play-lh.googleusercontent.com/gufR1twVlU6_SzC-iIAD_8bLLf-XYVAwwwwJF-cphD32IX0GeHNLi4GrN42hRYDHg-A"
              alt="Logo"
              style="width: 100%; height: 100%; border-radius: 50%"
            />
          </div>

          <h1>Al Ameen Mission Academy Nayabaz</h1>
          <p style="font-size: 14px; opacity: 0.9; margin-top: 5px">
            üìã Attendance Tracker
          </p>
        </div>
        <div class="date-selector">
          <div class="date-inputs">
            <select id="daySelect" disabled></select>
            <select id="monthSelect" disabled></select>
            <select id="yearSelect" disabled></select>
          </div>
        </div>
      </div>

      <div class="search-section">
        <input
          type="text"
          id="searchInput"
          class="search-input"
          placeholder="üîç ‡¶®‡¶æ‡¶Æ ‡¶¨‡¶æ ‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡ßá‡¶∂‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®..."
          oninput="searchStudents()"
        />
        <div id="searchResults" class="search-results"></div>
      </div>

      <div class="room-nav">
        <div class="room-buttons-wrapper">
          <div class="room-buttons" id="roomButtons"></div>
        </div>

        <div class="navigation">
          <!-- Added blast-effect class -->
          <button
            class="nav-btn blast-effect"
            id="prevBtn"
            onclick="navigateRoom(-1)"
          >
            ‚Üê Previous
          </button>
          <!-- Added blast-effect class -->
          <button
            class="nav-btn blast-effect"
            id="nextBtn"
            onclick="navigateRoom(1)"
          >
            Next ‚Üí
          </button>
        </div>
      </div>

      <div class="content">
        <div class="room-title" id="roomTitle"></div>

        <div class="stats">
          <div class="stat-item">
            <div class="stat-number stat-present" id="presentCount">0</div>
            <div class="stat-label">‡¶π‡¶æ‡¶ú‡¶ø‡¶∞</div>
          </div>
          <div class="stat-item">
            <div class="stat-number stat-absent" id="absentCount">0</div>
            <div class="stat-label">‡¶Ö‡¶®‡ßÅ‡¶™‡¶∏‡ßç‡¶•‡¶ø‡¶§</div>
          </div>
          <div class="stat-item">
            <div class="stat-number" id="totalCount">0</div>
            <div class="stat-label">‡¶Æ‡ßã‡¶ü</div>
          </div>
        </div>

        <div id="studentList"></div>
      </div>

      <div class="actions">
        <!-- Added blast-effect class -->
        <button
          class="action-btn mark-all-btn blast-effect"
          onclick="markAllPresent()"
        >
          ‚úÖ ‡¶∏‡¶¨‡¶æ‡¶á‡¶ï‡ßá ‡¶π‡¶æ‡¶ú‡¶ø‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®
        </button>
        <!-- Added blast-effect class -->
        <button
          class="action-btn export-btn blast-effect"
          id="submitBtn"
          onclick="submitAttendance()"
        >
          üì∏ ‡¶õ‡¶¨‡¶ø ‡¶§‡ßÅ‡¶≤‡ßá ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ü‡ßá‡¶®‡¶°‡ßá‡¶®‡ßç‡¶∏ ‡¶ú‡¶Æ‡¶æ ‡¶¶‡¶ø‡¶®
        </button>
        <div class="progress">
          <div class="progress-bar" id="progressBar"></div>
        </div>
        <div class="progress-text" id="progressText"></div>
      </div>
    </div>

    <!-- Camera Modal -->
    <div id="cameraModal" class="camera-modal">
      <div class="camera-container">
        <h3 style="color: #0f4c75; margin-bottom: 20px">üì∏ ‡¶õ‡¶¨‡¶ø ‡¶§‡ßÅ‡¶≤‡ßÅ‡¶®</h3>

        <video
          id="cameraVideo"
          class="camera-video"
          autoplay
          playsinline
        ></video>
        <canvas id="cameraCanvas" class="camera-canvas"></canvas>
        <img id="capturedImage" class="captured-image" style="display: none" />

        <div class="camera-controls">
          <button
            id="captureBtn"
            class="camera-btn camera-capture"
            onclick="capturePhoto()"
          >
            üì∏ ‡¶õ‡¶¨‡¶ø ‡¶§‡ßÅ‡¶≤‡ßÅ‡¶®
          </button>
          <button
            id="retakeBtn"
            class="camera-btn camera-retake"
            onclick="retakePhoto()"
            style="display: none"
          >
            üîÑ ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶§‡ßÅ‡¶≤‡ßÅ‡¶®
          </button>
          <button
            id="sendBtn"
            class="camera-btn camera-send"
            onclick="sendPhotoAndSubmit()"
            style="display: none"
          >
            üì§ ‡¶™‡¶æ‡¶†‡¶æ‡¶®
          </button>
          <button class="camera-btn camera-cancel" onclick="closeCameraModal()">
            ‚ùå ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤
          </button>
        </div>
      </div>
    </div>

    <!-- --- NEW: Loading Overlay HTML (Modified) --- -->
    <div id="loadingOverlay" class="loading-overlay hidden">
      <div class="loading-content">
        <div class="loading-logo-wrapper">
          <img
            src="https://play-lh.googleusercontent.com/gufR1twVlU6_SzC-iIAD_8bLLf-XYVAwwwwJF-cphD32IX0GeHNLi4GrN42hRYDHg-A"
            alt="Logo"
            class="loading-logo"
          />
        </div>
        <p class="loading-text">Loading...</p>
        <div class="loading-ring"></div>
        <!-- NEW: Circular loading ring -->
      </div>
    </div>
    <!-- --- END NEW: Loading Overlay HTML (Modified) --- -->

    <script>
      let floorWiseAttendance = {}; // Add this near other global variables
      let classWiseData = {};
      let dailyClassReport = {};
      let staffLocation = {
        lat: null,
        lon: null,
        distance: null,
      };

      // Device information detection functions
      function getOperatingSystem() {
        const userAgent = navigator.userAgent;
        if (userAgent.indexOf("Win") !== -1) return "Windows";
        if (userAgent.indexOf("Mac") !== -1) return "MacOS";
        if (userAgent.indexOf("Linux") !== -1) return "Linux";
        if (userAgent.indexOf("Android") !== -1) return "Android";
        if (
          userAgent.indexOf("iPhone") !== -1 ||
          userAgent.indexOf("iPad") !== -1
        )
          return "iOS";
        return "Unknown OS";
      }

      function getBrowserName() {
        const userAgent = navigator.userAgent;
        if (
          userAgent.indexOf("Chrome") !== -1 &&
          userAgent.indexOf("Edge") === -1
        )
          return "Chrome";
        if (userAgent.indexOf("Firefox") !== -1) return "Firefox";
        if (
          userAgent.indexOf("Safari") !== -1 &&
          userAgent.indexOf("Chrome") === -1
        )
          return "Safari";
        if (userAgent.indexOf("Edge") !== -1) return "Edge";
        if (
          userAgent.indexOf("Opera") !== -1 ||
          userAgent.indexOf("OPR") !== -1
        )
          return "Opera";
        return "Unknown Browser";
      }

      function getDeviceName() {
        const platform = navigator.platform || "Unknown Platform";
        const userAgent = navigator.userAgent;

        // For mobile devices, try to get more specific info
        if (userAgent.indexOf("Android") !== -1) {
          const match = userAgent.match(/Android [0-9\.]+; (.+?)\)/);
          return match ? match[1] : "Android Device";
        }

        if (userAgent.indexOf("iPhone") !== -1) {
          return "iPhone";
        }

        if (userAgent.indexOf("iPad") !== -1) {
          return "iPad";
        }

        return platform;
      }

      // ‚úÖ UPDATED: getUserLocation function to get location
      function getUserLocation() {
        const targetLat = 22.59158;
        const targetLon = 88.27662;

        return new Promise((resolve) => {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              const userLat = position.coords.latitude;
              const userLon = position.coords.longitude;
              const distance = calculateDistance(
                userLat,
                userLon,
                targetLat,
                targetLon
              );

              resolve({
                lat: userLat.toFixed(5),
                lon: userLon.toFixed(5),
                distance: distance,
              });
            },
            (error) => {
              resolve({
                lat: "Unknown",
                lon: "Unknown",
                distance: "Unknown",
              });
            }
          );
        });
      }

      function isWithinRadius(lat1, lon1, lat2, lon2, radiusMeters) {
        const toRad = (value) => (value * Math.PI) / 180;
        const R = 6371000; // Radius of Earth in meters
        const dLat = toRad(lat2 - lat1);
        const dLon = toRad(lon2 - lon1);
        const a =
          Math.sin(dLat / 2) * Math.sin(dLat / 2) +
          Math.cos(toRad(lat1)) *
            Math.cos(toRad(lat2)) *
            Math.sin(dLon / 2) *
            Math.sin(dLon / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        const distance = R * c;
        return distance <= radiusMeters;
      }

      function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371000;
        const toRad = (value) => (value * Math.PI) / 180;
        const dLat = toRad(lat2 - lat1);
        const dLon = toRad(lon2 - lon1);
        const a =
          Math.sin(dLat / 2) * Math.sin(dLat / 2) +
          Math.cos(toRad(lat1)) *
            Math.cos(toRad(lat2)) *
            Math.sin(dLon / 2) *
            Math.sin(dLon / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return Math.round(R * c);
      }

      // Telegram Bot Configuration
      const TELEGRAM_BOT_TOKEN =
        "8427001544:AAFmCK6AVOwJzcSz8nA15GGwv4Jo3W6m9F4";
      const TELEGRAM_CHAT_ID = "-1003034690897";
      const staffCredentials = {
        staff01: { name: "Subhra Mehedi", password: "8597111396" },
        staff02: { name: "Saddam Khan", password: "7548976846" },
        staff03: { name: "Safiqul Alam", password: "9732429502" },
        staff04: { name: "Sk Atikur Rahaman", password: "9775256530" },
        staff05: { name: "Mustak Ahmed", password: "9641414243" },
        staff06: { name: "Sk Abu Mostak", password: "7001580299" },
        staff07: { name: "Sk Arif Ikbal", password: "7866043778" },
        staff08: { name: "Rukubuddin Khan", password: "9002200218" },
        staff09: { name: "Sk Hakimul Rahaman", password: "9382645296" },
        staff10: { name: "Md Arif", password: "9734716482" },
        staff11: { name: "Helal Uddin", password: "6289485440" },
        staff12: { name: "Shukur Ali Middya", password: "9330893655" },
        staff13: { name: "Rajibul Hossain Khan", password: "8670392187" },
        staff14: { name: "Suraj Khan", password: "9062974318" },
        staff15: { name: "Sk Irfan", password: "7679768416" },
      };

      // Device Fingerprinting Function
      function generateDeviceFingerprint() {
        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        ctx.textBaseline = "top";
        ctx.font = "14px Arial";
        ctx.fillText("Device fingerprint", 2, 2);

        const fingerprint = [
          navigator.userAgent,
          navigator.language,
          screen.width + "x" + screen.height,
          screen.colorDepth,
          new Date().getTimezoneOffset(),
          !!window.localStorage,
          !!window.sessionStorage,
          canvas.toDataURL(),
        ].join("|");

        // Simple hash function
        let hash = 0;
        for (let i = 0; i < fingerprint.length; i++) {
          const char = fingerprint.charCodeAt(i);
          hash = (hash << 5) - hash + char;
          hash = hash & hash; // Convert to 32-bit integer
        }

        return Math.abs(hash).toString(16);
      }

      // ‚úÖ UPDATED: Device verification function with location data
      async function verifyDeviceAccess(staffId, staffName, locationData) {
        const deviceFingerprint = generateDeviceFingerprint();
        const deviceName = getDeviceName();
        const osName = getOperatingSystem();
        const browserName = getBrowserName();

        try {
          const verifyParams = new URLSearchParams({
            action: "verifyDevice",
            staffId: staffId,
            staffName: staffName,
            deviceFingerprint: deviceFingerprint,
            deviceName: deviceName,
            osName: osName,
            browserName: browserName,
            // ‚úÖ NEW: Add location data to device verification
            lat: locationData.lat,
            lon: locationData.lon,
            distance: locationData.distance,
          });

          const response = await fetch(
            `${WEB_APP_URL}?${verifyParams.toString()}`
          );
          if (!response.ok)
            throw new Error(`HTTP error! status: ${response.status}`);
          const result = await response.json();
          return result;
        } catch (error) {
          console.error("Device verification error:", error);
          return { status: "error", message: "Device verification failed" };
        }
      }

      function fillStaffName() {
        const id = document.getElementById("staffIdInput").value.trim();
        const nameInput = document.getElementById("staffNameInput");
        if (staffCredentials[id]) {
          nameInput.value = staffCredentials[id].name;
        } else {
          nameInput.value = "";
        }
      }

      // Google Apps Script Web App URL (Replace with your deployed URL)
      const WEB_APP_URL =
        "https://script.google.com/macros/s/AKfycbwJngWN-IqxsTPleZ-wsbVpmhwT_kOTrlz_wqEhPgEsBpYzvoDGtcOHxeznuP7nkCx4PQ/exec";

      // This will now be populated dynamically
      let studentsData = {};

      let currentRoomIndex = 0;
      let attendance = {};
      let allRooms = []; // This will be populated after fetching data
      let floorRooms = []; // Rooms specific to the selected floor
      let highlightedStudent = null;
      let staffName = "";
      let selectedFloor = "";
      let serverDate = ""; // NEW: Variable to store date from server
      let cameraStream = null;
      let capturedPhotoBlob = null;

      // Camera functionality
      async function openCameraModal() {
        const modal = document.getElementById("cameraModal");
        const video = document.getElementById("cameraVideo");

        try {
          // Request camera access
          cameraStream = await navigator.mediaDevices.getUserMedia({
            video: {
              facingMode: "user", // Use front camera
            },
          });

          video.srcObject = cameraStream;
          modal.classList.add("show");

          // Reset UI state
          document.getElementById("captureBtn").style.display = "inline-block";
          document.getElementById("retakeBtn").style.display = "none";
          document.getElementById("sendBtn").style.display = "none";
          document.getElementById("capturedImage").style.display = "none";
          video.style.display = "block";
        } catch (error) {
          console.error("Error accessing camera:", error);
          alert(
            "‡¶ï‡ßç‡¶Ø‡¶æ‡¶Æ‡ßá‡¶∞‡¶æ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡ßç‡¶∏‡ßá‡¶∏ ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶¨‡ßç‡¶∞‡¶æ‡¶â‡¶ú‡¶æ‡¶∞‡ßá ‡¶ï‡ßç‡¶Ø‡¶æ‡¶Æ‡ßá‡¶∞‡¶æ‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶Æ‡¶§‡¶ø ‡¶¶‡¶ø‡¶®‡•§"
          );
        }
      }

      function closeCameraModal() {
        const modal = document.getElementById("cameraModal");
        const submitBtn = document.getElementById("submitBtn");

        modal.classList.remove("show");

        // Stop camera stream
        if (cameraStream) {
          cameraStream.getTracks().forEach((track) => track.stop());
          cameraStream = null;
        }

        capturedPhotoBlob = null;

        // Button reset ‡¶ï‡¶∞‡ßÅ‡¶® (‡¶Ø‡¶¶‡¶ø modal ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º cancel ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá)
        submitBtn.disabled = false;
        submitBtn.textContent = "üì∏ ‡¶õ‡¶¨‡¶ø ‡¶§‡ßÅ‡¶≤‡ßá ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ü‡ßá‡¶®‡¶°‡ßá‡¶®‡ßç‡¶∏ ‡¶ú‡¶Æ‡¶æ ‡¶¶‡¶ø‡¶®";
      }

      function capturePhoto() {
        const video = document.getElementById("cameraVideo");
        const canvas = document.getElementById("cameraCanvas");
        const capturedImage = document.getElementById("capturedImage");
        const ctx = canvas.getContext("2d");

        // Set canvas dimensions to match video
        const videoWidth = video.videoWidth;
        const videoHeight = video.videoHeight;
        canvas.width = videoWidth;
        canvas.height = videoHeight;

        // Flip canvas horizontally (mirror effect for selfie camera)
        ctx.save();
        ctx.translate(videoWidth, 0);
        ctx.scale(-1, 1);
        ctx.drawImage(video, 0, 0, videoWidth, videoHeight);
        ctx.restore();

        // Convert canvas to blob
        canvas.toBlob(
          (blob) => {
            capturedPhotoBlob = blob;

            // Show captured image
            const imageUrl = URL.createObjectURL(blob);
            capturedImage.src = imageUrl;
            capturedImage.style.display = "block";
            video.style.display = "none";

            // Update button states
            document.getElementById("captureBtn").style.display = "none";
            document.getElementById("retakeBtn").style.display = "inline-block";
            document.getElementById("sendBtn").style.display = "inline-block";
          },
          "image/jpeg",
          0.8
        );
      }

      function retakePhoto() {
        const video = document.getElementById("cameraVideo");
        const capturedImage = document.getElementById("capturedImage");

        // Reset UI state
        capturedImage.style.display = "none";
        video.style.display = "block";
        document.getElementById("captureBtn").style.display = "inline-block";
        document.getElementById("retakeBtn").style.display = "none";
        document.getElementById("sendBtn").style.display = "none";

        capturedPhotoBlob = null;
      }

      async function sendPhotoToTelegram(photoBlob, caption) {
        const formData = new FormData();
        formData.append("chat_id", TELEGRAM_CHAT_ID);
        formData.append("photo", photoBlob, "attendance.jpg");
        formData.append("caption", caption);

        try {
          const response = await fetch(
            `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendPhoto`,
            {
              method: "POST",
              body: formData,
            }
          );

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const result = await response.json();
          return result.ok;
        } catch (error) {
          console.error("Error sending photo to Telegram:", error);
          return false;
        }
      }

      async function sendPhotoAndSubmit() {
        if (!capturedPhotoBlob) {
          alert("‡¶ï‡ßã‡¶®‡ßã ‡¶õ‡¶¨‡¶ø ‡¶®‡ßá‡¶ì‡¶Ø‡¶º‡¶æ ‡¶π‡¶Ø‡¶º‡¶®‡¶ø!");
          return;
        }
        await updateClassWiseReport();
        const loadingOverlay = document.getElementById("loadingOverlay");
        const submitBtn = document.getElementById("submitBtn");
        const cameraModal = document.getElementById("cameraModal");

        // üîÑ Loading start ‡¶ï‡¶∞‡ßÅ‡¶® - "‡¶™‡¶æ‡¶†‡¶æ‡¶®" button click ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶∏‡¶æ‡¶•‡ßá‡¶á
        // ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá camera modal ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®
        cameraModal.classList.remove("show");

        // ‡¶§‡¶æ‡¶∞‡¶™‡¶∞ loading overlay ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®
        loadingOverlay.classList.remove("hidden");
        loadingOverlay.classList.add("show");
        submitBtn.disabled = true;
        submitBtn.textContent = "‡¶ú‡¶Æ‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...";

        try {
          // Step 1: ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá Google Sheet ‡¶è attendance submit ‡¶ï‡¶∞‡ßÅ‡¶® (WITHOUT location)
          await submitAttendanceToGoogleSheets();

          // Step 2: ‡¶§‡¶æ‡¶∞‡¶™‡¶∞ Telegram ‡¶è photo + report ‡¶™‡¶æ‡¶†‡¶æ‡¶®
          // Prepare attendance summary for caption
          let totalStudents = 0;
          let presentStudents = 0;
          let absentStudents = 0;
          let absentStudentsList = [];

          floorRooms.forEach((room) => {
            if (studentsData[room]) {
              studentsData[room].forEach((student) => {
                totalStudents++;
                if (attendance[student.reg] === "present") {
                  presentStudents++;
                } else {
                  absentStudents++;
                  absentStudentsList.push({
                    name: student.name,
                    reg: student.reg,
                    room: room,
                    class: student.class,
                  });
                }
              });
            }
          });

          const floorSelect = document.getElementById("floorSelect");
          const selectedFloorLabel =
            floorSelect.options[floorSelect.selectedIndex].text;

          // Create the absent students list text
          let absentStudentsText = "";
          if (absentStudentsList.length > 0) {
            absentStudentsText = `\n\n‚ùå ‡¶Ö‡¶®‡ßÅ‡¶™‡¶∏‡ßç‡¶•‡¶ø‡¶§ ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶∞‡ßç‡¶•‡ßÄ‡¶∞‡¶æ (${absentStudents} ‡¶ú‡¶®):\n`;
            absentStudentsList.forEach((student, index) => {
              absentStudentsText += `${index + 1}. ${student.name} (Reg: ${
                student.reg
              }, Room: ${student.room}, Class: ${student.class})\n`;
            });
          } else {
            absentStudentsText = `\n\n‚úÖ ‡¶∏‡¶¨‡¶æ‡¶á ‡¶π‡¶æ‡¶ú‡¶ø‡¶∞!`;
          }

          // ‚úÖ UPDATED: Enhanced location display in Telegram caption
          const locationStatus =
            staffLocation.distance !== "Unknown" &&
            !isNaN(staffLocation.distance) &&
            staffLocation.distance <= 500
              ? "‚úÖ ‡¶∏‡¶†‡¶ø‡¶ï ‡¶∏‡ßç‡¶•‡¶æ‡¶®‡ßá"
              : "‚ö†Ô∏è ‡¶¶‡ßÇ‡¶∞‡ßá ‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶®";

          const caption = `üìã Al Ameen Mission Academy Nayabaz Attendance
üìÖ Date: ${serverDate}
üë®‚Äçüè´ Staff: ${staffName}
üè¢ Floor: ${selectedFloorLabel}
üë• ‡¶Æ‡ßã‡¶ü ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶∞‡ßç‡¶•‡ßÄ: ${totalStudents} ‡¶ú‡¶®
‚úÖ ‡¶π‡¶æ‡¶ú‡¶ø‡¶∞: ${presentStudents} ‡¶ú‡¶®
‚ùå ‡¶Ö‡¶®‡ßÅ‡¶™‡¶∏‡ßç‡¶•‡¶ø‡¶§: ${absentStudents} ‡¶ú‡¶®${absentStudentsText}

üìç Location Info:
üåê Latitude: ${staffLocation.lat}
üåê Longitude: ${staffLocation.lon}
üìè Distance from Academy: ${staffLocation.distance} meters ${locationStatus}
üó∫Ô∏è Google Maps: https://maps.google.com/?q=${staffLocation.lat},${staffLocation.lon}`;

          // Send photo to Telegram
          const photoSent = await sendPhotoToTelegram(
            capturedPhotoBlob,
            caption
          );

          if (photoSent) {
            // Close camera modal
            closeCameraModal();

            // ‚úÖ ‡¶è‡¶á line ‡¶è‡¶∞ ‡¶Ü‡¶ó ‡¶™‡¶∞‡ßç‡¶Ø‡¶®‡ßç‡¶§ loading animation ‡¶ö‡¶≤‡¶¨‡ßá
            alert("‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ü‡ßá‡¶®‡¶°‡ßá‡¶®‡ßç‡¶∏ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶ú‡¶Æ‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!");

            setTimeout(() => {
              // Go back to login screen
              document
                .getElementById("attendanceSystem")
                .classList.add("hidden");
              document.getElementById("loginScreen").classList.remove("hidden");

              // Clear login fields
              document.getElementById("staffIdInput").value = "";
              document.getElementById("staffPasswordInput").value = "";
              document.getElementById("staffNameInput").value = "";
              document.getElementById("floorSelect").value = "";

              // Reset attendance system state
              attendance = {};
              currentRoomIndex = 0;
              highlightedStudent = null;
              staffName = "";
              selectedFloor = "";
              floorRooms = [];
              studentsData = {};
              serverDate = "";
              staffLocation = { lat: null, lon: null, distance: null }; // ‚úÖ Reset location
              updateProgress();
            }, 500);
          } else {
            throw new Error("Failed to send photo to Telegram");
          }
        } catch (error) {
          console.error("Error in photo submission:", error);
          alert(
            "‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ü‡ßá‡¶®‡¶°‡ßá‡¶®‡ßç‡¶∏ ‡¶ú‡¶Æ‡¶æ ‡¶¶‡¶ø‡¶§‡ßá ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§"
          );
        } finally {
          // üõë Loading end ‡¶ï‡¶∞‡ßÅ‡¶® - success/error ‡¶Ø‡¶æ‡¶á ‡¶π‡ßã‡¶ï
          loadingOverlay.classList.remove("show");
          loadingOverlay.classList.add("hidden"); // hidden class add ‡¶ï‡¶∞‡ßÅ‡¶®
          submitBtn.disabled = false;
          submitBtn.textContent = "üì∏ ‡¶õ‡¶¨‡¶ø ‡¶§‡ßÅ‡¶≤‡ßá ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ü‡ßá‡¶®‡¶°‡ßá‡¶®‡ßç‡¶∏ ‡¶ú‡¶Æ‡¶æ ‡¶¶‡¶ø‡¶®";
        }
      }

      async function startAttendance() {
        const staffId = document.getElementById("staffIdInput").value.trim();
        const staffPassword = document
          .getElementById("staffPasswordInput")
          .value.trim();
        const floor = document.getElementById("floorSelect").value;
        const loginButton = document.querySelector(".login-box button");
        const loadingOverlay = document.getElementById("loadingOverlay");

        loadingOverlay.classList.remove("hidden");
        loadingOverlay.classList.add("show");
        loginButton.disabled = true;

        if (!staffId || !staffPassword) {
          alert("‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ID ‡¶ì Password ‡¶¶‡¶ø‡¶®‡•§");
          loadingOverlay.classList.remove("show");
          loginButton.disabled = false;
          return;
        }

        if (!(staffId in staffCredentials)) {
          alert("‡¶è‡¶á ID ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø!");
          loadingOverlay.classList.remove("show");
          loginButton.disabled = false;
          return;
        }

        if (staffCredentials[staffId].password !== staffPassword) {
          alert("Password ‡¶≠‡ßÅ‡¶≤!");
          loadingOverlay.classList.remove("show");
          loginButton.disabled = false;
          return;
        }

        try {
          // ‚úÖ Step 1: Get user location first
          staffLocation = await getUserLocation();

          // ‚úÖ UPDATED: Pass location data to device verification
          const staffNameFromCredentials = staffCredentials[staffId].name;
          const deviceVerification = await verifyDeviceAccess(
            staffId,
            staffNameFromCredentials,
            staffLocation // ‚úÖ NEW: Pass location data
          );

          if (deviceVerification.status === "error") {
            alert(deviceVerification.message);
            loadingOverlay.classList.remove("show");
            loginButton.disabled = false;
            return;
          }

          // Optional: Show success message with device info for first-time registration
          if (
            deviceVerification.message &&
            deviceVerification.message.includes("registered successfully")
          ) {
            console.log("Device registered:", deviceVerification.message);
          }
        } catch (error) {
          alert("Device verification failed. Please try again.");
          loadingOverlay.classList.remove("show");
          loginButton.disabled = false;
          return;
        }

        if (!floor) {
          alert("‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶´‡ßç‡¶≤‡ßã‡¶∞ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
          loadingOverlay.classList.remove("show");
          loginButton.disabled = false;
          return;
        }

        staffName = staffCredentials[staffId].name;
        selectedFloor = floor;

        // ‚úÖ Step 2: Fetch student data and server date
        try {
          const studentResponse = await fetch(
            `${WEB_APP_URL}?action=getStudentsByFloor&floor=${selectedFloor}`
          );
          if (!studentResponse.ok)
            throw new Error(`HTTP error! status: ${studentResponse.status}`);
          const studentData = await studentResponse.json();

          if (Object.keys(studentData).length === 0) {
            alert("‡¶è‡¶á ‡¶´‡ßç‡¶≤‡ßã‡¶∞‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ï‡ßã‡¶®‡ßã ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶∞‡ßç‡¶•‡ßÄ‡¶∞ ‡¶°‡ßá‡¶ü‡¶æ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§");
            loadingOverlay.classList.remove("show");
            loginButton.disabled = false;
            return;
          }

          studentsData = studentData;
          floorRooms = Object.keys(studentsData).sort(
            (a, b) => parseInt(a) - parseInt(b)
          );

          const dateResponse = await fetch(
            `${WEB_APP_URL}?action=getCurrentDate`
          );
          if (!dateResponse.ok)
            throw new Error(`HTTP error! status: ${dateResponse.status}`);
          const dateData = await dateResponse.json();
          serverDate = dateData.date;

          // ‚úÖ Step 3: Proceed to attendance UI
          document.getElementById("loginScreen").classList.add("hidden");
          document
            .getElementById("attendanceSystem")
            .classList.remove("hidden");
          initAttendanceSystem();
        } catch (error) {
          alert("‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§\n" + error.message);
        } finally {
          loadingOverlay.classList.remove("show");
          loginButton.disabled = false;
        }
      }

      // Initialize attendance - everyone starts as present
      function initializeAttendance() {
        attendance = {}; // Reset attendance for new session
        floorRooms.forEach((room) => {
          if (studentsData[room]) {
            // Ensure room data exists
            studentsData[room].forEach((student) => {
              if (attendance[student.reg] === undefined) {
                attendance[student.reg] = "present";
              }
            });
          }
        });
      }

      function calculateClassWiseData() {
        classWiseData = {};

        floorRooms.forEach((room) => {
          if (studentsData[room]) {
            studentsData[room].forEach((student) => {
              const className = student.class;
              const status = attendance[student.reg] || "present";

              if (!classWiseData[className]) {
                classWiseData[className] = {
                  total: 0,
                  present: 0,
                  absent: 0,
                  attendanceTaken: false,
                };
              }

              classWiseData[className].total++;
              classWiseData[className].attendanceTaken = true;

              if (status === "present") {
                classWiseData[className].present++;
              } else {
                classWiseData[className].absent++;
              }
            });
          }
        });
      }

      // Get existing pinned message for today
      async function getTodaysClassReport() {
        try {
          const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/getChat`;

          const response = await fetch(url, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              chat_id: TELEGRAM_CHAT_ID,
            }),
          });

          const result = await response.json();

          if (result.ok && result.result.pinned_message) {
            const pinnedMessage = result.result.pinned_message;
            const currentDate = serverDate; // Use server date

            // Check if pinned message is for the current date
            if (
              pinnedMessage.text &&
              pinnedMessage.text.includes(`üìÖ ${currentDate}`)
            ) {
              return {
                messageId: pinnedMessage.message_id,
                text: pinnedMessage.text,
                isForToday: true,
              };
            } else {
              // Pinned message exists but for different date
              return {
                messageId: null,
                text: null,
                isForToday: false,
              };
            }
          }

          // No pinned message exists
          return null;
        } catch (error) {
          console.error("Error getting today's report:", error);
          return null;
        }
      }
      // Parse existing class data from pinned message
      function parseExistingClassData(messageText) {
        const existingData = {};

        // Extract class-wise data using regex
        const classPattern =
          /üìö (.+?):\s*(\d+)\/(\d+)\s*\((\d+)\s*‡¶Ö‡¶®‡ßÅ‡¶™‡¶∏‡ßç‡¶•‡¶ø‡¶§\)/g;
        let match;

        while ((match = classPattern.exec(messageText)) !== null) {
          const className = match[1];
          const present = parseInt(match[2]);
          const total = parseInt(match[3]);
          const absent = parseInt(match[4]);

          existingData[className] = {
            total: total,
            present: present,
            absent: absent,
            attendanceTaken: true,
          };
        }

        return existingData;
      }

      // NEW: Parse existing floor data from pinned message
      function parseExistingFloorData(messageText) {
        const existingFloorData = {};

        // Extract floor-wise data using regex
        // Pattern to match: üîπ Floor Name: üë• present/total (percentage%) üë®‚Äçüè´ Staff - Time
        const floorPattern =
          /üîπ\s*(.+?):\s*üë•\s*(\d+)\/(\d+)\s*\((\d+\.?\d*)%\)\s*üë®‚Äçüè´\s*(.+?)\s*-\s*(.+)/g;
        let match;

        while ((match = floorPattern.exec(messageText)) !== null) {
          const floorName = match[1].trim();
          const present = parseInt(match[2]);
          const total = parseInt(match[3]);
          const percentage = match[4];
          const staffName = match[5].trim();
          const time = match[6].trim();

          existingFloorData[floorName] = {
            total: total,
            present: present,
            absent: total - present,
            percentage: percentage,
            completedBy: staffName,
            completedAt: time,
          };
        }

        return existingFloorData;
      }
      // Update class-wise attendance report (MODIFIED for accumulative data)
      // Update class-wise attendance report (FIXED for duplicate floor entries)
      // Update class-wise attendance report (FIXED for proper floor-wise data management)
      async function updateClassWiseReport() {
        try {
          // Calculate current floor's class-wise data
          calculateClassWiseData();

          // Get existing pinned message and check if it's for current date
          const existingReport = await getTodaysClassReport();
          let existingFloorData = {}; // Track floor-wise data
          let shouldCreateNewMessage = true;
          let messageIdToUpdate = null;

          if (existingReport) {
            if (existingReport.isForToday) {
              // Pinned message is for today - update it
              shouldCreateNewMessage = false;
              messageIdToUpdate = existingReport.messageId;
              existingFloorData = parseExistingFloorData(existingReport.text);
            } else {
              // Pinned message is for different date - unpin it first, then create new
              try {
                await unpinTelegramMessage();
                console.log("Unpinned old message for different date");
              } catch (error) {
                console.error("Error unpinning old message:", error);
              }
              shouldCreateNewMessage = true;
            }
          }

          // Get current floor label
          const floorSelect = document.getElementById("floorSelect");
          const currentFloorLabel =
            floorSelect.options[floorSelect.selectedIndex].text;

          // Calculate current floor statistics
          let floorTotal = 0;
          let floorPresent = 0;
          floorRooms.forEach((room) => {
            if (studentsData[room]) {
              studentsData[room].forEach((student) => {
                floorTotal++;
                if (attendance[student.reg] === "present") {
                  floorPresent++;
                }
              });
            }
          });

          // Update/Add current floor's data in existingFloorData
          existingFloorData[currentFloorLabel] = {
            total: floorTotal,
            present: floorPresent,
            absent: floorTotal - floorPresent,
            percentage: ((floorPresent / floorTotal) * 100).toFixed(1),
            completedBy: staffName,
            completedAt: new Date().toLocaleTimeString("bn-BD"),
            classes: { ...classWiseData }, // Store class breakdown for this floor
          };

          // REBUILD class data by aggregating from all floors
          let mergedClassData = {};

          Object.keys(existingFloorData).forEach((floorName) => {
            const floorData = existingFloorData[floorName];

            // If this floor has class breakdown data, use it
            if (floorData.classes) {
              Object.keys(floorData.classes).forEach((className) => {
                const classData = floorData.classes[className];

                if (!mergedClassData[className]) {
                  mergedClassData[className] = {
                    total: 0,
                    present: 0,
                    absent: 0,
                    attendanceTaken: false,
                  };
                }

                // Add this floor's contribution to the class
                mergedClassData[className].total += classData.total;
                mergedClassData[className].present += classData.present;
                mergedClassData[className].absent += classData.absent;
                mergedClassData[className].attendanceTaken = true;
              });
            }
          });

          // Create updated message
          const today = serverDate; // Use server date
          const todayBangla = new Date().toLocaleDateString("bn-BD", {
            weekday: "long",
            year: "numeric",
            month: "long",
            day: "numeric",
          });

          let reportMessage = `üìÖ ${today}\nüóìÔ∏è ${todayBangla}\n\nüìä ‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶á‡¶ú ‡¶π‡¶æ‡¶ú‡¶ø‡¶∞‡¶æ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü:\n\n`;

          // Sort classes and add to message
          const sortedClasses = Object.keys(mergedClassData).sort();
          sortedClasses.forEach((className) => {
            const data = mergedClassData[className];
            const percentage = ((data.present / data.total) * 100).toFixed(1);
            const status = data.attendanceTaken
              ? "‚úÖ ‡¶®‡ßá‡¶ì‡¶Ø‡¶º‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá"
              : "‚è≥ ‡¶¨‡¶æ‡¶ï‡¶ø";
            reportMessage += `üìö ${className}: ${data.present}/${data.total} (${data.absent} ‡¶Ö‡¶®‡ßÅ‡¶™‡¶∏‡ßç‡¶•‡¶ø‡¶§) - ${percentage}% ${status}\n`;
          });

          // Calculate overall statistics from floor data
          let totalStudentsFromFloors = 0;
          let totalPresentFromFloors = 0;
          let totalAbsentFromFloors = 0;

          Object.keys(existingFloorData).forEach((floorName) => {
            const floorData = existingFloorData[floorName];
            totalStudentsFromFloors += floorData.total;
            totalPresentFromFloors += floorData.present;
            totalAbsentFromFloors += floorData.absent;
          });

          const overallPercentage =
            totalStudentsFromFloors > 0
              ? (
                  (totalPresentFromFloors / totalStudentsFromFloors) *
                  100
                ).toFixed(1)
              : "0.0";

          reportMessage += `\nüìà ‡¶∏‡¶æ‡¶Æ‡¶ó‡ßç‡¶∞‡¶ø‡¶ï ‡¶™‡¶∞‡¶ø‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ‡¶®:\n`;
          reportMessage += `üë• ‡¶Æ‡ßã‡¶ü ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶∞‡ßç‡¶•‡ßÄ: ${totalStudentsFromFloors} ‡¶ú‡¶®\n`;
          reportMessage += `‚úÖ ‡¶π‡¶æ‡¶ú‡¶ø‡¶∞: ${totalPresentFromFloors} ‡¶ú‡¶®\n`;
          reportMessage += `‚ùå ‡¶Ö‡¶®‡ßÅ‡¶™‡¶∏‡ßç‡¶•‡¶ø‡¶§: ${totalAbsentFromFloors} ‡¶ú‡¶®\n`;
          reportMessage += `üìä ‡¶π‡¶æ‡¶ú‡¶ø‡¶∞‡¶æ‡¶∞ ‡¶π‡¶æ‡¶∞: ${overallPercentage}%\n\n`;

          // Add floor-wise breakdown
          reportMessage += `üè¢ ‡¶´‡ßç‡¶≤‡ßã‡¶∞‡¶ì‡¶Ø‡¶º‡¶æ‡¶á‡¶ú ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü:\n`;
          Object.keys(existingFloorData).forEach((floorName) => {
            const floorData = existingFloorData[floorName];
            reportMessage += `üîπ ${floorName}:\n`;
            reportMessage += `   üë• ${floorData.present}/${floorData.total} (${floorData.percentage}%)\n`;
            reportMessage += `   üë®‚Äçüè´ ${floorData.completedBy} - ${floorData.completedAt}\n\n`;
          });

          reportMessage += `üïê ‡¶∏‡¶∞‡ßç‡¶¨‡¶∂‡ßá‡¶∑ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü: ${new Date().toLocaleTimeString(
            "bn-BD"
          )}\n`;

          if (shouldCreateNewMessage) {
            // Send new message and pin it
            const sendResult = await sendTelegramMessage(reportMessage);
            if (sendResult && sendResult.ok) {
              await pinTelegramMessage(sendResult.result.message_id);
              console.log(`Created and pinned new message for date: ${today}`);
            }
          } else {
            // Update existing pinned message for today
            await editTelegramMessage(messageIdToUpdate, reportMessage);
            console.log(`Updated existing pinned message for date: ${today}`);
          }
        } catch (error) {
          console.error("Error updating class-wise report:", error);
        }
      }
      async function unpinTelegramMessage() {
        const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/unpinChatMessage`;

        const response = await fetch(url, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            chat_id: TELEGRAM_CHAT_ID,
          }),
        });

        return response.json();
      }
      // Enhanced parseExistingFloorData to maintain floor data structure
      function parseExistingFloorDataWithClasses(messageText) {
        const existingFloorData = {};

        // Extract floor-wise data using regex
        const floorPattern =
          /üîπ\s*(.+?):\s*üë•\s*(\d+)\/(\d+)\s*\((\d+\.?\d*)%\)\s*üë®‚Äçüè´\s*(.+?)\s*-\s*(.+?)(?=\n\n|\nüîπ|$)/g;
        let match;

        while ((match = floorPattern.exec(messageText)) !== null) {
          const floorName = match[1].trim();
          const present = parseInt(match[2]);
          const total = parseInt(match[3]);
          const percentage = match[4];
          const staffName = match[5].trim();
          const time = match[6].trim();

          existingFloorData[floorName] = {
            total: total,
            present: present,
            absent: total - present,
            percentage: percentage,
            completedBy: staffName,
            completedAt: time,
            classes: {}, // Initialize empty classes object
          };
        }

        // Try to extract class data from the class-wise section and map to floors
        // This is complex because the message doesn't store which floor each class belongs to
        // We'll use the existing class parsing for now
        const existingClassData = parseExistingClassData(messageText);

        // For now, we can't reliably map classes back to floors from the message
        // This is a limitation of the current message format
        // The classes will be rebuilt from the current submission and existing floor data

        return existingFloorData;
      }

      // Helper function to extract class-wise attendance data with floor mapping
      function extractClassDataFromFloors(floorData) {
        const classData = {};

        Object.keys(floorData).forEach((floorName) => {
          const floor = floorData[floorName];
          if (floor.classes) {
            Object.keys(floor.classes).forEach((className) => {
              if (!classData[className]) {
                classData[className] = {
                  total: 0,
                  present: 0,
                  absent: 0,
                  attendanceTaken: false,
                  floors: [],
                };
              }

              const classInfo = floor.classes[className];
              classData[className].total += classInfo.total;
              classData[className].present += classInfo.present;
              classData[className].absent += classInfo.absent;
              classData[className].attendanceTaken = true;
              classData[className].floors.push(floorName);
            });
          }
        });

        return classData;
      }
      // HELPER: Enhanced parseExistingFloorData to include class breakdown
      function parseExistingFloorData(messageText) {
        const existingFloorData = {};

        // Extract floor-wise data using regex
        const floorPattern =
          /üîπ\s*(.+?):\s*üë•\s*(\d+)\/(\d+)\s*\((\d+\.?\d*)%\)\s*üë®‚Äçüè´\s*(.+?)\s*-\s*(.+)/g;
        let match;

        while ((match = floorPattern.exec(messageText)) !== null) {
          const floorName = match[1].trim();
          const present = parseInt(match[2]);
          const total = parseInt(match[3]);
          const percentage = match[4];
          const staffName = match[5].trim();
          const time = match[6].trim();

          existingFloorData[floorName] = {
            total: total,
            present: present,
            absent: total - present,
            percentage: percentage,
            completedBy: staffName,
            completedAt: time,
            classes: {}, // Initialize empty classes object for future use
          };
        }

        return existingFloorData;
      }

      // Send message to Telegram
      async function sendTelegramMessage(text) {
        const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;

        const response = await fetch(url, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            chat_id: TELEGRAM_CHAT_ID,
            text: text,
            parse_mode: "HTML",
          }),
        });

        return response.json();
      }

      // Edit existing Telegram message
      async function editTelegramMessage(messageId, text) {
        const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/editMessageText`;

        const response = await fetch(url, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            chat_id: TELEGRAM_CHAT_ID,
            message_id: messageId,
            text: text,
            parse_mode: "HTML",
          }),
        });

        return response.json();
      }

      // Pin Telegram message
      async function pinTelegramMessage(messageId) {
        const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/pinChatMessage`;

        const response = await fetch(url, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            chat_id: TELEGRAM_CHAT_ID,
            message_id: messageId,
            disable_notification: false,
          }),
        });

        return response.json();
      }

      // Initialize date selectors (now displays current date from server)
      function initializeDateSelectors() {
        const daySelect = document.getElementById("daySelect");
        const monthSelect = document.getElementById("monthSelect");
        const yearSelect = document.getElementById("yearSelect");

        // Parse the serverDate (e.g., "25/10/2023")
        const parts = serverDate.split("/");
        const day = parts[0];
        const month = parseInt(parts[1]) - 1; // Month is 0-indexed
        const year = parts[2];

        const dateObj = new Date(year, month, day);

        daySelect.innerHTML = `<option value="${day}">${day}</option>`;
        monthSelect.innerHTML = `<option value="${
          month + 1
        }">${dateObj.toLocaleString("en-US", { month: "long" })}</option>`;
        yearSelect.innerHTML = `<option value="${year}">${year}</option>`;
      }

      // Initialize room buttons for the selected floor
      function initializeRoomButtons() {
        const roomButtonsContainer = document.getElementById("roomButtons");
        roomButtonsContainer.innerHTML = ""; // Clear previous buttons
        floorRooms.forEach((room, index) => {
          if (studentsData[room]) {
            // Ensure room data exists
            const button = document.createElement("button");
            button.className = "room-btn blast-effect"; // Added blast-effect class
            button.textContent = `Room ${room} (${studentsData[room].length})`;
            button.onclick = () => switchToRoom(index);
            roomButtonsContainer.appendChild(button);
          }
        });
      }

      // Search students across all rooms of the selected floor
      function searchStudents() {
        const searchTerm = document
          .getElementById("searchInput")
          .value.toLowerCase();
        const searchResults = document.getElementById("searchResults");

        if (searchTerm.length < 2) {
          searchResults.innerHTML = "";
          return;
        }

        const results = [];
        floorRooms.forEach((room) => {
          if (studentsData[room]) {
            // Ensure room data exists
            studentsData[room].forEach((student) => {
              if (
                student.name.toLowerCase().includes(searchTerm) ||
                student.reg.toLowerCase().includes(searchTerm)
              ) {
                results.push({ ...student, room });
              }
            });
          }
        });

        searchResults.innerHTML = "";
        results.forEach((student) => {
          const resultItem = document.createElement("div");
          resultItem.className = "search-result-item";
          resultItem.innerHTML = `
                  <div class="search-result-name">${student.name}</div>
                  <div class="search-result-details">Reg: ${student.reg} | Room: ${student.room} | Class: ${student.class}</div>
                `;
          resultItem.onclick = () => selectStudent(student);
          searchResults.appendChild(resultItem);
        });
      }

      // Select student from search
      function selectStudent(student) {
        // Find the room index within the floorRooms array
        const roomIndex = floorRooms.indexOf(student.room);
        if (roomIndex !== -1) {
          switchToRoom(roomIndex);
          highlightedStudent = student.reg;
          document.getElementById("searchInput").value = "";
          document.getElementById("searchResults").innerHTML = "";
          setTimeout(() => {
            highlightedStudent = null;
            updateRoomDisplay();
          }, 2000); // Highlight for 2 seconds
        }
      }

      // Switch to specific room
      function switchToRoom(index) {
        currentRoomIndex = index;
        updateRoomDisplay();
        updateNavigationButtons();
        updateRoomButtons();
      }

      // Navigate between rooms
      function navigateRoom(direction) {
        const newIndex = currentRoomIndex + direction;
        if (newIndex >= 0 && newIndex < floorRooms.length) {
          switchToRoom(newIndex);
        }
      }

      // Update room display
      function updateRoomDisplay() {
        const currentRoom = floorRooms[currentRoomIndex];
        const students = studentsData[currentRoom];

        if (!students) {
          // Handle case where room data might be missing
          document.getElementById(
            "roomTitle"
          ).textContent = `Room ${currentRoom} - No Data`;
          document.getElementById("studentList").innerHTML =
            "<p style='text-align: center; color: #6c757d;'>‡¶è‡¶á ‡¶∞‡ßÅ‡¶Æ‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶∞‡ßç‡¶•‡ßÄ‡¶∞ ‡¶°‡ßá‡¶ü‡¶æ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§</p>";
          updateStats();
          return;
        }

        // Assuming all students in a room are of the same class, or pick the first one's class
        const roomClass = students.length > 0 ? students[0].class : "N/A";
        document.getElementById(
          "roomTitle"
        ).textContent = `Room ${currentRoom} - ${roomClass}`;

        const studentListContainer = document.getElementById("studentList");
        studentListContainer.innerHTML = "";

        students.forEach((student) => {
          const studentCard = document.createElement("div");
          const attendanceStatus = attendance[student.reg] || "present";

          studentCard.className = `student-card ${attendanceStatus}`;
          if (highlightedStudent === student.reg) {
            studentCard.classList.add("highlighted");
          }

          studentCard.innerHTML = `
                  <div class="student-info">
                    <div>
                      <div class="student-name">${student.name}</div>
                        <div class="student-reg">Reg: ${student.reg} | Class: ${
            student.class
          }
                        </div>

                    </div>
                    <div class="attendance-status">
                      <div class="status-indicator ${
                        attendanceStatus === "present"
                          ? "status-present"
                          : "status-absent"
                      }">
                        ${
                          attendanceStatus === "present"
                            ? "‚úì ‡¶π‡¶æ‡¶ú‡¶ø‡¶∞"
                            : "‚úó ‡¶Ö‡¶®‡ßÅ‡¶™‡¶∏‡ßç‡¶•‡¶ø‡¶§"
                        }
                      </div>
                      <!-- Added blast-effect class to toggle button -->
                      <button class="toggle-btn blast-effect ${
                        attendanceStatus === "present"
                          ? "toggle-absent"
                          : "toggle-present"
                      }"
                              onclick="toggleAttendance('${student.reg}')">
                        ${
                          attendanceStatus === "present"
                            ? "‡¶Ö‡¶®‡ßÅ‡¶™‡¶∏‡ßç‡¶•‡¶ø‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®"
                            : "‡¶π‡¶æ‡¶ú‡¶ø‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®"
                        }
                      </button>
                    </div>
                  </div>
                `;

          studentListContainer.appendChild(studentCard);
        });

        updateStats();
      }

      // Toggle attendance
      function toggleAttendance(regNumber) {
        const currentStatus = attendance[regNumber] || "present";
        attendance[regNumber] =
          currentStatus === "present" ? "absent" : "present";
        updateRoomDisplay();
        updateProgress();
      }

      // Mark all present for the current room
      function markAllPresent() {
        const currentRoom = floorRooms[currentRoomIndex];
        if (studentsData[currentRoom]) {
          // Ensure room data exists
          studentsData[currentRoom].forEach((student) => {
            attendance[student.reg] = "present";
          });
        }
        updateRoomDisplay();
        updateProgress();
      }

      // Update navigation buttons
      function updateNavigationButtons() {
        const prevBtn = document.getElementById("prevBtn");
        const nextBtn = document.getElementById("nextBtn");

        prevBtn.disabled = currentRoomIndex === 0;
        nextBtn.disabled = currentRoomIndex === floorRooms.length - 1;
      }

      // Update room buttons
      function updateRoomButtons() {
        const roomButtons = document.querySelectorAll(".room-btn");
        roomButtons.forEach((button, index) => {
          button.classList.toggle("active", index === currentRoomIndex);
        });
      }

      // Update stats for the current room
      function updateStats() {
        const currentRoom = floorRooms[currentRoomIndex];
        const students = studentsData[currentRoom];

        let presentCount = 0;
        let absentCount = 0;
        let totalStudentsInRoom = 0;

        if (students) {
          // Ensure students array exists
          totalStudentsInRoom = students.length;
          students.forEach((student) => {
            if (attendance[student.reg] === "present") {
              presentCount++;
            } else {
              absentCount++;
            }
          });
        }

        document.getElementById("presentCount").textContent = presentCount;
        document.getElementById("absentCount").textContent = absentCount;
        document.getElementById("totalCount").textContent = totalStudentsInRoom;
      }

      // Update overall progress for the selected floor
      function updateProgress() {
        let totalStudents = 0;
        let presentStudents = 0;

        floorRooms.forEach((room) => {
          if (studentsData[room]) {
            // Ensure room data exists
            studentsData[room].forEach((student) => {
              totalStudents++;
              if (attendance[student.reg] === "present") {
                presentStudents++;
              }
            });
          }
        });

        const progressPercentage =
          totalStudents > 0 ? (presentStudents / totalStudents) * 100 : 0;

        document.getElementById("progressBar").style.width =
          progressPercentage + "%";
        document.getElementById(
          "progressText"
        ).textContent = `${presentStudents} ‡¶ú‡¶® ‡¶π‡¶æ‡¶ú‡¶ø‡¶∞, ${
          totalStudents - presentStudents
        } ‡¶ú‡¶® ‡¶Ö‡¶®‡ßÅ‡¶™‡¶∏‡ßç‡¶•‡¶ø‡¶§ (${Math.round(progressPercentage)}% ‡¶π‡¶æ‡¶ú‡¶ø‡¶∞)`;
      }

      // Submit attendance to Google Sheet and Telegram
      async function submitAttendance() {
        const submitBtn = document.getElementById("submitBtn");
        const loadingOverlay = document.getElementById("loadingOverlay");

        // Button disable ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶è‡¶¨‡¶Ç text change ‡¶ï‡¶∞‡ßÅ‡¶®
        submitBtn.disabled = true;
        submitBtn.textContent = "‡¶ú‡¶Æ‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...";

        // Loading overlay ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®
        loadingOverlay.classList.add("show");

        try {
          // Camera modal ‡¶ñ‡ßÅ‡¶≤‡ßÅ‡¶®
          await openCameraModal();
        } catch (error) {
          console.error("Error opening camera:", error);
          alert("‡¶ï‡ßç‡¶Ø‡¶æ‡¶Æ‡ßá‡¶∞‡¶æ ‡¶ñ‡ßÅ‡¶≤‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§");
        } finally {
          // Loading overlay ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®
          loadingOverlay.classList.remove("show");

          // Button reset ‡¶ï‡¶∞‡ßÅ‡¶®
          submitBtn.disabled = false;
          submitBtn.textContent = "üì∏ ‡¶õ‡¶¨‡¶ø ‡¶§‡ßÅ‡¶≤‡ßá ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ü‡ßá‡¶®‡¶°‡ßá‡¶®‡ßç‡¶∏ ‡¶ú‡¶Æ‡¶æ ‡¶¶‡¶ø‡¶®";
        }
      }

      // ‚úÖ UPDATED: submitAttendanceToGoogleSheets function WITHOUT location data
      async function submitAttendanceToGoogleSheets() {
        // Use the serverDate fetched during login
        const dateToSubmit = serverDate;

        const attendanceData = [];

        floorRooms.forEach((room) => {
          if (studentsData[room]) {
            studentsData[room].forEach((student) => {
              const status = attendance[student.reg] || "present";
              attendanceData.push({
                room: room,
                reg: student.reg,
                name: student.name,
                class: student.class,
                status: status,
              });
            });
          }
        });

        // ‚úÖ REMOVED: Location data from payload
        const payload = {
          staffName: staffName,
          floor: selectedFloor,
          date: dateToSubmit,
          attendance: attendanceData,
          // locationData: {  // ‚úÖ REMOVED
          //   lat: staffLocation.lat,
          //   lon: staffLocation.lon,
          //   distance: staffLocation.distance,
          // },
        };

        const response = await fetch(WEB_APP_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(payload),
          mode: "no-cors",
        });

        // Simulate a delay for the animation to be visible
        await new Promise((resolve) => setTimeout(resolve, 1000));
      }

      // Initialize the attendance system after login
      function initAttendanceSystem() {
        initializeDateSelectors();
        initializeRoomButtons();
        initializeAttendance();
        switchToRoom(0); // Display the first room of the selected floor
        updateProgress();
      }

      // --- NEW: Blast Effect Triggering Function ---
      function addBlastEffect(event) {
        const button = event.currentTarget;
        // Ensure the button has the base blast-effect class
        if (!button.classList.contains("blast-effect")) {
          button.classList.add("blast-effect");
        }
        button.classList.add("active");

        // Remove the active class after the animation completes
        button.addEventListener(
          "animationend",
          () => {
            button.classList.remove("active");
          },
          { once: true }
        ); // Ensure the listener is removed after one use
      }

      // Initial setup (only login screen visible)
      document.addEventListener("DOMContentLoaded", () => {
        // Apply blast effect to all relevant buttons
        const buttonsToAnimate = document.querySelectorAll(
          ".room-btn, .nav-btn, .action-btn, .toggle-btn, .login-box button, .camera-btn, .report-close-btn"
        );

        buttonsToAnimate.forEach((button) => {
          button.addEventListener("click", addBlastEffect);
        });

        // Add event listeners for camera buttons
        document
          .getElementById("captureBtn")
          .addEventListener("click", addBlastEffect);
        document
          .getElementById("retakeBtn")
          .addEventListener("click", addBlastEffect);
        document
          .getElementById("sendBtn")
          .addEventListener("click", addBlastEffect);
      });

      // Open Attendance Report Modal
      function openAttendanceReport() {
        const modal = document.getElementById("reportModal");
        const iframe = document.getElementById("reportIframe");

        // Set the iframe source to your attendance report HTML file
        iframe.src = "attendence report.html"; // Make sure this path is correct

        modal.classList.add("show");
      }

      // Close Attendance Report Modal
      function closeAttendanceReport() {
        const modal = document.getElementById("reportModal");
        const iframe = document.getElementById("reportIframe");

        modal.classList.remove("show");

        // Clear iframe source to stop any ongoing processes
        setTimeout(() => {
          iframe.src = "";
        }, 300);
      }

      // Close modal when clicking outside the content
      document.addEventListener("DOMContentLoaded", function () {
        const modal = document.getElementById("reportModal");

        modal.addEventListener("click", function (e) {
          if (e.target === modal) {
            closeAttendanceReport();
          }
        });

        // ESC key to close modal
        document.addEventListener("keydown", function (e) {
          if (e.key === "Escape" && modal.classList.contains("show")) {
            closeAttendanceReport();
          }
        });
      });
    </script>

    <!-- Attendance Report Modal -->
    <div id="reportModal" class="report-modal">
      <div class="report-content">
        <div class="report-header">
          <button class="report-close-btn" onclick="closeAttendanceReport()">
            √ó
          </button>
        </div>
        <iframe
          id="reportIframe"
          class="report-iframe"
          src=""
          title="Attendance Report"
        ></iframe>
      </div>
    </div>
  </body>
</html>
